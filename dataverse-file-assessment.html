<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Texas Data Repository file-level assessment script</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="dataverse-file-assessment_files/libs/clipboard/clipboard.min.js"></script>
<script src="dataverse-file-assessment_files/libs/quarto-html/quarto.js"></script>
<script src="dataverse-file-assessment_files/libs/quarto-html/popper.min.js"></script>
<script src="dataverse-file-assessment_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="dataverse-file-assessment_files/libs/quarto-html/anchor.min.js"></script>
<link href="dataverse-file-assessment_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="dataverse-file-assessment_files/libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="dataverse-file-assessment_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="dataverse-file-assessment_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="dataverse-file-assessment_files/libs/bootstrap/bootstrap-8a79a254b8e706d3c925cde0a310d4f0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Texas Data Repository file-level assessment script</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="metadata" class="level2">
<h2 class="anchored" data-anchor-id="metadata">Metadata</h2>
<ul>
<li><em>Version</em>: 0.0.4</li>
<li><em>Released</em>: 2025/07/08</li>
<li><em>Author(s)</em>: Bryan Gee (UT Libraries, University of Texas at Austin; bryan.gee@austin.utexas.edu; ORCID: <a href="https://orcid.org/0000-0003-4517-3290">0000-0003-4517-3290</a>)</li>
<li><em>Contributor(s)</em>: None</li>
<li><em>License</em>: <a href="https://www.gnu.org/licenses/gpl-3.0.en.html">GNU GPLv3</a></li>
<li><em>README last updated</em>: 2025/07/08</li>
</ul>
</section>
<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>This is the Jupyter Notebook version of the <em>dataverse-file-assessment.py</em> script. It contains the same functionality but is designed to provide a more detailed explanation of different steps and is targeted at an introductory level of familiarity with Python, APIs, and Dataverse. In theory, it should be accessible to a new institutional liaison for the Texas Data Repository (TDR) within a few weeks of their introduction to TDR as a whole.</p>
<section id="modules" class="level3">
<h3 class="anchored" data-anchor-id="modules">Modules</h3>
<p>You will need the following modules; several of these are not included in the default installation of Python and will need to be installed (e.g., through pip). If you need help getting started with how to install packages, please refer to this link: https://packaging.python.org/en/latest/tutorials/installing-packages/</p>
<div id="de84e17a" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> urllib.parse <span class="im">import</span> urlparse, parse_qs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="toggles" class="level3">
<h3 class="anchored" data-anchor-id="toggles">Toggles</h3>
<p>Toggles are Boolean (TRUE/FALSE) variables that define whether part of the workflow should or shouldn’t happen or in what fashion it should happen. For example, the <em>test</em> toggle will enable or disable ‘Test’ mode; when ‘Test’ is set to TRUE, it will cap how many records it retrieves in order to do a really quick run. Depending on the workflow and what you set the cap at, this could cut the runtime by as much as 99% to under a minute. This is ideal for making sure that the workflow as you have (re)configured it will work all the way through, rather than running in non-test mode and getting 80% of the way into an hour-long process, only to discover you have a code-breaking error at the end. There are four toggles in this workflow:</p>
<ul>
<li><strong>test</strong>: as noted above, this will enable or disable ‘Test’ mode. The restricted retrieval caps are defined in the <em>config.json</em> file (see next section).</li>
<li><strong>onlyMyInstitution</strong>: this toggle will define whether to look at only your institution (e.g., ‘UT Austin’) or all institutions in TDR. As a note, only a superuser will be able to retrieve certain records (e.g., drafts) for all dataverses; institutional liaisons will not be able to get this information for an institution that they don’t belong to.</li>
<li><strong>versionsAPI</strong>: the primary API endpoint that retrieves detailed metadata on individual datasets/files is the Native API. This endpoint only returns the most recent version’s metadata. Therefore, if metadata has changed over time, you may not get a complete record of something like total file size (if files have been replaced/deleted) or authorship (if authors have been removed) because everything except the latest version is not retrieved. The versions API will return the same level of detail for all versions, but it is more time-intensive because of this, and in some instances, it may be known or suspected that outdated versions do not contribute significantly (e.g., a dataset that has only been versioned to add metadata like keywords, without file changes). If the toggle is set to ‘TRUE,’ the script will loop through this endpoint as well.</li>
<li><strong>excludeDrafts</strong>: related to <em>onlyMyInstitution</em>, if you want to ensure standardized results across all institutions and don’t have superuser permissions, you may want to toggle this on to export versions of the final outputs that omit unpublished dataset.</li>
</ul>
<div id="076ed836" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#toggle for test environment (incomplete run, faster to complete)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>test <span class="op">=</span> <span class="va">True</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">#toggle to only look at your/one institution in TDR</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>onlyMyInstitution <span class="op">=</span> <span class="va">True</span> </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">#toggle for stage 3 retrieval</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>versionsAPI <span class="op">=</span> <span class="va">True</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">#toggle for excluding unpublished</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>excludeDrafts <span class="op">=</span> <span class="va">True</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="dates" class="level3">
<h3 class="anchored" data-anchor-id="dates">Dates</h3>
<p>Both for filenames and in order to calculate how long the script takes, we define two timestamps. These can then be dynamically called through the script.</p>
<div id="fc0d6cd6" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#setting timestamp at start of script to calculate run time</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>startTime <span class="op">=</span> datetime.now() </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">#creating variable with current date for appending to filenames</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>todayDate <span class="op">=</span> datetime.now().strftime(<span class="st">"%Y%m</span><span class="sc">%d</span><span class="st">"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="config-file" class="level3">
<h3 class="anchored" data-anchor-id="config-file">config file</h3>
<p>The <em>config.json</em> file, which can be variably named and in various formats (e.g., Michael uses a .env text file), provides parameters for the analysis. Externalizing the parameters helps to keep the script clean, since most parameters don’t need to be updated regularly, and protects sensitive information like API keys. This file should never be distributed to anyone else; instead, share the <em>config-template.json</em> file.</p>
<div id="b4d67799" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#read in config file</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'config.json'</span>, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> json.load(<span class="bu">file</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Because you can’t “comment out” remarks in a JSON file in the same way that you can with Python, I want to provide some comments on what’s in the config file below. The first example is showing you what’s in the ‘INSTITUTION’ block, which is various parameters for a specific institution. You will want to modify these in the same syntax for your own institution.</p>
<div id="804e118a" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>my_institution <span class="op">=</span> config[<span class="st">'INSTITUTION'</span>]</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(my_institution)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'name': 'University of Texas at Austin', 'filename': 'UT-austin', 'uniqueIdentifier': 'Austin', 'ror': 'https://ror.org/00hj54h04', 'myInstitution': 'UT Austin'}</code></pre>
</div>
</div>
<p>You don’t need to load in sequential levels of a nested object; you can go directly to the field you want, as shown below.</p>
<div id="cd244024" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">##read in filename version of your institution's name</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>my_institution_filename <span class="op">=</span> config[<span class="st">'INSTITUTION'</span>][<span class="st">'filename'</span>]</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">###condition what goes in the filename based on toggle for which institution(s) to ping</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> onlyMyInstitution:</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    institutionFilename <span class="op">=</span> my_institution_filename</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    institutionFilename <span class="op">=</span> <span class="st">"all-institutions"</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">##read in short-hand version of your institution's name</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>my_institution_shortName <span class="op">=</span> config[<span class="st">"INSTITUTION"</span>][<span class="st">"myInstitution"</span>]</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'String to add to filenames: </span><span class="sc">{</span>my_institution_filename<span class="sc">}</span><span class="ss">.</span><span class="ch">\n</span><span class="ss">'</span>)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Short hand version of institution name: </span><span class="sc">{</span>my_institution_shortName<span class="sc">}</span><span class="ss">.</span><span class="ch">\n</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>String to add to filenames: UT-austin.

Short hand version of institution name: UT Austin.
</code></pre>
</div>
</div>
<p>The ‘VARIABLES’ field is what dictates the size of the retrieval to be made. Limits on attributes like page size (how many in one call), page count (how many in a total call), and starting parameters will be defined in API documentation: https://guides.dataverse.org/en/latest/api/index.html. Each API is slightly different, so you will need to adapt code based on the API. This script only uses the Dataverse API, but if you need help with the Crossref, DataCite, Dryad, Figshare, OpenAlex, or Zenodo APIs, reach out to Bryan who has code for all of these. For this specific script, you should (be able to) leave these API parameters as is.</p>
<div id="50fe8047" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>apiParams <span class="op">=</span> config[<span class="st">'VARIABLES'</span>]</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(apiParams)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'PAGE_SIZES': {'datacite_prod': 1000, 'datacite_test': 200, 'dataverse': 200}, 'PAGE_LIMITS': {'datacite_test': 5, 'datacite_prod': 600, 'dspace_test': 3, 'dspace_prod': 100, 'tdr_test': 10, 'tdr_prod': 100}, 'PAGE_STARTS': {'datacite': 0, 'dataverse': 0}, 'PAGE_INCREMENTS': {'dataverse': 1}}</code></pre>
</div>
</div>
<p>Not all of the fields (either first-order or nested fields) are used for this script. Some of them pertain only to the other script in this repository (which isn’t really that related to be honest). You won’t need to bother with the various permutations of your institution’s name, for example. Most of the config file is taken up by these dictionaries of key-value pairs or lists of strings. For example, the ‘WORDS’ field shown below is a series of words that are considered non-descriptive; these are used for a metadata assessment of dataset titles down the line.</p>
<div id="10f1a32d" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>words <span class="op">=</span> config[<span class="st">'WORDS'</span>]</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(words)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'articles': ['a', 'the', 'thee', 'an'], 'conjunctions': ['and', 'or', 'but'], 'prepositions': ['in', 'to', 'of', 'for', 'with', 'as', 'from'], 'auxiliary_verbs': ['is', 'are', 'was', 'were'], 'possessives': ['our', 'my'], 'descriptors': ['data', 'dataset', 'dataverse', 'repository', 'code', 'codes', 'script', 'scripts', 'software', 'supplemental', 'supplementary', 'supporting', 'figure', 'table', 'figures', 'tables', 'file', 'files', 'et al.', 'raw', 'manuscript', 'article', 'journal', 'preprint', 'replication', 'readme', 'github', 'final', 'output'], 'order': ['S1', 'S2', 'S3'], 'version': ['v1', 'v1.0', 'v2', 'v2.0', 'v3', 'v3.0']}</code></pre>
</div>
</div>
<p>Several fields are key-value pairs of mimeType file formats and friendly file formats. These are used to systematically assess datasets and files to look for things like whether there is a code file or a README file.</p>
<div id="bf2c21fb" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>compressed <span class="op">=</span> config[<span class="st">'COMPRESSED_FORMATS'</span>]</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(compressed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'application/gzip': 'GZIP (compressed archive)', 'application/x-7z-compressed': '7z (compressed archive)', 'application/x-gzip': 'GZIP (compressed archive)', 'application/x-rar': 'RAR (compressed archive)', 'application/x-tar': 'TAR (compressed archive)', 'application/zip': 'ZIP (compressed archive)', 'TAR/GNU Zip (.tar.gz/.tgz) (application/x-gzip)': 'TAR.GZ (compressed archive)', 'ZIP: PKZIP (application/zip)': 'ZIP (compressed archive)'}</code></pre>
</div>
</div>
<p><strong>Can you just tell me what I need to do with the <em>config.json</em> file?</strong></p>
<p>There are only three things you need to change in this file to tailor it for another institution:</p>
<ul>
<li><p><strong>Add your Dataverse API token</strong>: this is the first field in the config file and should be blank (““) in the template. In order to get your token, log into TDR, go to your name at the top right, and click the dropdown arrow - you should see an API token button. Do not share your token!</p></li>
<li><p><strong>Update [‘INSTITUTION’][‘filename’]</strong>: this is the string that will automatically be baked into filenames (so that you don’t have to manually go through and change many lines of code). This can be whatever you want.</p></li>
<li><p><strong>Update [“INSTITUTION”][“myInstitution”]</strong>: this is a controlled vocabulary that I cooked up for this workflow. Pick your institution out of the following:</p>
<ul>
<li>“Baylor”</li>
<li>“Houston”</li>
<li>“HSC Fort Worth”</li>
<li>“SMU”</li>
<li>“TAMU”</li>
<li>“TAMU Galveston”</li>
<li>“TAMU International”</li>
<li>“Texas State”</li>
<li>“Texas Tech”</li>
<li>“Texas Women’s University”</li>
<li>“UT Arlington”</li>
<li>“UT Austin”</li>
<li>“UT San Antonio Health”</li>
<li>“UT Southwestern Medical”</li>
</ul></li>
</ul>
<p>Specifically for Texas A&amp;M, enter “TAMU” to get records from all three TAMU campuses; there is a downstream process to make sure that it pulls from all three dataverses. This process currently includes some institutions that are no longer members of TDR.</p>
</section>
<section id="remaining-set-up" class="level3">
<h3 class="anchored" data-anchor-id="remaining-set-up">Remaining set-up</h3>
<p>The next few blocks handle the rest of the the setting up of the scripting process. The first step is to create some directories. This script is pretty simple, but in order to ensure that files are consistently saved and read from the same places for everyone, the script will first look for certain subdirectories in the folder where this script is contained and make them if they don’t exist. As you can see, if the ‘Test’ toggle is enabled, it will make a <em>test</em> subdirectory and change the directory to <em>test.</em> So test and non-test outputs are separated to avoid any confusion.</p>
<div id="48335b44" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">#creating directories</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> test:</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.isdir(<span class="st">"test"</span>):</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"test directory found - no need to recreate"</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        os.mkdir(<span class="st">"test"</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"test directory has been created"</span>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    os.chdir(<span class="st">'test'</span>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.isdir(<span class="st">"outputs"</span>):</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"test outputs directory found - no need to recreate"</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>        os.mkdir(<span class="st">"outputs"</span>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"test outputs directory has been created"</span>)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.isdir(<span class="st">"outputs"</span>):</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"outputs directory found - no need to recreate"</span>)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>        os.mkdir(<span class="st">"outputs"</span>)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"outputs directory has been created"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>test directory found - no need to recreate
test outputs directory found - no need to recreate</code></pre>
</div>
</div>
</section>
<section id="utilized-api-endpoints" class="level3">
<h3 class="anchored" data-anchor-id="utilized-api-endpoints">Utilized API endpoints</h3>
<p>For maximum coverage, we need to query three different endpoints in the Dataverse API. A comparison of what information is retrieved from these</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="dataverse-apis-information-comparison.png" class="img-fluid figure-img"></p>
<figcaption>Comparison of information retrieved from Dataverse endpoints</figcaption>
</figure>
</div>
<section id="basic-api-params" class="level4">
<h4 class="anchored" data-anchor-id="basic-api-params">Basic API params</h4>
<p>The next step is basic API parameters. This block defines the first API endpoint (the <a href="https://guides.dataverse.org/en/latest/api/search.html">Search API</a>). It then dynamically calls in certain parameters about retrieval size limits from the <em>config.json</em> file, with different values based on whether you are in the Test mode. The API key is also called in. The value ‘<em>k</em>’ is kept in here, instead of the <em>config.json</em> file, because it should always be set as zero (i.e.&nbsp;don’t touch that). It’s used to count pages while the API call is being made. The <em>query</em> value is set as the DOI prefix for all TDR deposits - this is because you cannot do a blank search through the API, so you need a value that you know will return 100% of datasets.</p>
<div id="fa421717" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Beginning to define API call parameters."</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>url_tdr <span class="op">=</span> <span class="st">"https://dataverse.tdl.org/api/search/"</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">##set API-specific params</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">###Dataverse</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>page_limit_dataverse <span class="op">=</span> config[<span class="st">'VARIABLES'</span>][<span class="st">'PAGE_LIMITS'</span>][<span class="st">'tdr_test'</span>] <span class="cf">if</span> test <span class="cf">else</span> config[<span class="st">'VARIABLES'</span>][<span class="st">'PAGE_LIMITS'</span>][<span class="st">'tdr_prod'</span>]</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>page_size <span class="op">=</span> config[<span class="st">'VARIABLES'</span>][<span class="st">'PAGE_SIZES'</span>][<span class="st">'dataverse'</span>] <span class="cf">if</span> test <span class="cf">else</span> config[<span class="st">'VARIABLES'</span>][<span class="st">'PAGE_SIZES'</span>][<span class="st">'dataverse'</span>]</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Retrieving </span><span class="sc">{</span>page_size<span class="sc">}</span><span class="ss"> records per page over </span><span class="sc">{</span>page_limit_dataverse<span class="sc">}</span><span class="ss"> pages."</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co">###for TDR, affiliation is not reliable for returning all relevant results; the DOI prefix is used as the most generic common denominator for datasets</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="st">'10.18738/T8/'</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>page_start_dataverse <span class="op">=</span> config[<span class="st">'VARIABLES'</span>][<span class="st">'PAGE_STARTS'</span>][<span class="st">'dataverse'</span>]</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>page_increment <span class="op">=</span> config[<span class="st">'VARIABLES'</span>][<span class="st">'PAGE_INCREMENTS'</span>][<span class="st">'dataverse'</span>]</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>headers_tdr <span class="op">=</span> {</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'X-Dataverse-key'</span>: config[<span class="st">'KEYS'</span>][<span class="st">'dataverseToken'</span>]</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Beginning to define API call parameters.
Retrieving 200 records per page over 10 pages.</code></pre>
</div>
</div>
</section>
<section id="institution-specific-parameters" class="level4">
<h4 class="anchored" data-anchor-id="institution-specific-parameters">Institution-specific parameters</h4>
<p>The next codeblock is using what’s called the ‘subtree’; this is a field that contains a unique code for each institution and directs to your institution’s specific dataverse. Each institution has its own set of parameters, which are largely constant between them except for the subtree, defined.</p>
<div id="46611990" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>params_tdr_ut_austin <span class="op">=</span> {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'q'</span>: query,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'subtree'</span>: <span class="st">'utexas'</span>,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'type'</span>: <span class="st">'dataset'</span>,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'start'</span>: page_start_dataverse,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'page'</span>: page_increment,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'per_page'</span>: page_limit_dataverse</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>params_tdr_baylor <span class="op">=</span> {</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'q'</span>: query,</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'subtree'</span>: <span class="st">'baylor'</span>,</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'type'</span>: <span class="st">'dataset'</span>,</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'start'</span>: page_start_dataverse,</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'page'</span>: page_increment,</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'per_page'</span>: page_limit_dataverse</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>params_tdr_smu <span class="op">=</span> {</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'q'</span>: query,</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">'subtree'</span>: <span class="st">'smu'</span>,</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">'type'</span>: <span class="st">'dataset'</span>,</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">'start'</span>: page_start_dataverse,</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">'page'</span>: page_increment,</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">'per_page'</span>: page_limit_dataverse</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>params_tdr_tamu <span class="op">=</span> {</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">'q'</span>: query,</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">'subtree'</span>: <span class="st">'tamu'</span>,</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">'type'</span>: <span class="st">'dataset'</span>,</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">'start'</span>: page_start_dataverse,</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">'page'</span>: page_increment,</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">'per_page'</span>: page_limit_dataverse</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>params_tdr_txst <span class="op">=</span> {</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">'q'</span>: query,</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">'subtree'</span>: <span class="st">'txst'</span>,</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">'type'</span>: <span class="st">'dataset'</span>,</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">'start'</span>: page_start_dataverse,</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">'page'</span>: page_increment,</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">'per_page'</span>: page_limit_dataverse</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>params_tdr_ttu <span class="op">=</span> {</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">'q'</span>: query,</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">'subtree'</span>: <span class="st">'ttu'</span>,</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">'type'</span>: <span class="st">'dataset'</span>,</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">'start'</span>: page_start_dataverse,</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">'page'</span>: page_increment,</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">'per_page'</span>: page_limit_dataverse</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>params_tdr_houston <span class="op">=</span> {</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">'q'</span>: query,</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">'subtree'</span>: <span class="st">'uh'</span>,</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">'type'</span>: <span class="st">'dataset'</span>,</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">'start'</span>: page_start_dataverse,</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">'page'</span>: page_increment,</span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">'per_page'</span>: page_limit_dataverse</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>params_tdr_hscfw <span class="op">=</span> {</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>    <span class="st">'q'</span>: query,</span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>    <span class="st">'subtree'</span>: <span class="st">'unthsc'</span>,</span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">'type'</span>: <span class="st">'dataset'</span>,</span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>    <span class="st">'start'</span>: page_start_dataverse,</span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>    <span class="st">'page'</span>: page_increment,</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">'per_page'</span>: page_limit_dataverse</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>params_tdr_tamug <span class="op">=</span> {</span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>    <span class="st">'q'</span>: query,</span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>    <span class="st">'subtree'</span>: <span class="st">'tamug'</span>,</span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>    <span class="st">'type'</span>: <span class="st">'dataset'</span>,</span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>    <span class="st">'start'</span>: page_start_dataverse,</span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>    <span class="st">'page'</span>: page_increment,</span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a>    <span class="st">'per_page'</span>: page_limit_dataverse</span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a>params_tdr_tamui <span class="op">=</span> {</span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a>    <span class="st">'q'</span>: query,</span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a>    <span class="st">'subtree'</span>: <span class="st">'tamiu'</span>,</span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a>    <span class="st">'type'</span>: <span class="st">'dataset'</span>,</span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a>    <span class="st">'start'</span>: page_start_dataverse,</span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>    <span class="st">'page'</span>: page_increment,</span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a>    <span class="st">'per_page'</span>: page_limit_dataverse</span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-89"><a href="#cb19-89" aria-hidden="true" tabindex="-1"></a>params_tdr_utsah <span class="op">=</span> {</span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a>    <span class="st">'q'</span>: query,</span>
<span id="cb19-91"><a href="#cb19-91" aria-hidden="true" tabindex="-1"></a>    <span class="st">'subtree'</span>: <span class="st">'uthscsa'</span>,</span>
<span id="cb19-92"><a href="#cb19-92" aria-hidden="true" tabindex="-1"></a>    <span class="st">'type'</span>: <span class="st">'dataset'</span>,</span>
<span id="cb19-93"><a href="#cb19-93" aria-hidden="true" tabindex="-1"></a>    <span class="st">'start'</span>: page_start_dataverse,</span>
<span id="cb19-94"><a href="#cb19-94" aria-hidden="true" tabindex="-1"></a>    <span class="st">'page'</span>: page_increment,</span>
<span id="cb19-95"><a href="#cb19-95" aria-hidden="true" tabindex="-1"></a>    <span class="st">'per_page'</span>: page_limit_dataverse</span>
<span id="cb19-96"><a href="#cb19-96" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-97"><a href="#cb19-97" aria-hidden="true" tabindex="-1"></a>params_tdr_utswm <span class="op">=</span> {</span>
<span id="cb19-98"><a href="#cb19-98" aria-hidden="true" tabindex="-1"></a>    <span class="st">'q'</span>: query,</span>
<span id="cb19-99"><a href="#cb19-99" aria-hidden="true" tabindex="-1"></a>    <span class="st">'subtree'</span>: <span class="st">'utswmed'</span>,</span>
<span id="cb19-100"><a href="#cb19-100" aria-hidden="true" tabindex="-1"></a>    <span class="st">'type'</span>: <span class="st">'dataset'</span>,</span>
<span id="cb19-101"><a href="#cb19-101" aria-hidden="true" tabindex="-1"></a>    <span class="st">'start'</span>: page_start_dataverse,</span>
<span id="cb19-102"><a href="#cb19-102" aria-hidden="true" tabindex="-1"></a>    <span class="st">'page'</span>: page_increment,</span>
<span id="cb19-103"><a href="#cb19-103" aria-hidden="true" tabindex="-1"></a>    <span class="st">'per_page'</span>: page_limit_dataverse</span>
<span id="cb19-104"><a href="#cb19-104" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-105"><a href="#cb19-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-106"><a href="#cb19-106" aria-hidden="true" tabindex="-1"></a>params_tdr_uta <span class="op">=</span> {</span>
<span id="cb19-107"><a href="#cb19-107" aria-hidden="true" tabindex="-1"></a>    <span class="st">'q'</span>: query,</span>
<span id="cb19-108"><a href="#cb19-108" aria-hidden="true" tabindex="-1"></a>    <span class="st">'subtree'</span>: <span class="st">'uta'</span>,</span>
<span id="cb19-109"><a href="#cb19-109" aria-hidden="true" tabindex="-1"></a>    <span class="st">'type'</span>: <span class="st">'dataset'</span>,</span>
<span id="cb19-110"><a href="#cb19-110" aria-hidden="true" tabindex="-1"></a>    <span class="st">'start'</span>: page_start_dataverse,</span>
<span id="cb19-111"><a href="#cb19-111" aria-hidden="true" tabindex="-1"></a>    <span class="st">'page'</span>: page_increment,</span>
<span id="cb19-112"><a href="#cb19-112" aria-hidden="true" tabindex="-1"></a>    <span class="st">'per_page'</span>: page_limit_dataverse</span>
<span id="cb19-113"><a href="#cb19-113" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-114"><a href="#cb19-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-115"><a href="#cb19-115" aria-hidden="true" tabindex="-1"></a>params_tdr_twu <span class="op">=</span> {</span>
<span id="cb19-116"><a href="#cb19-116" aria-hidden="true" tabindex="-1"></a>    <span class="st">'q'</span>: query,</span>
<span id="cb19-117"><a href="#cb19-117" aria-hidden="true" tabindex="-1"></a>    <span class="st">'subtree'</span>: <span class="st">'twu'</span>,</span>
<span id="cb19-118"><a href="#cb19-118" aria-hidden="true" tabindex="-1"></a>    <span class="st">'type'</span>: <span class="st">'dataset'</span>,</span>
<span id="cb19-119"><a href="#cb19-119" aria-hidden="true" tabindex="-1"></a>    <span class="st">'start'</span>: page_start_dataverse,</span>
<span id="cb19-120"><a href="#cb19-120" aria-hidden="true" tabindex="-1"></a>    <span class="st">'page'</span>: page_increment,</span>
<span id="cb19-121"><a href="#cb19-121" aria-hidden="true" tabindex="-1"></a>    <span class="st">'per_page'</span>: page_limit_dataverse</span>
<span id="cb19-122"><a href="#cb19-122" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="parameter-combinations" class="level4">
<h4 class="anchored" data-anchor-id="parameter-combinations">Parameter combinations</h4>
<p>The next codeblock is setting up the code to handle different conditions based on whether you want to look at only your institution or all TDR institutions. The <em>all_params</em> object combines all of the institution-specific parameters. The <em>tamu_combined_params</em> object combines only TAMU parameters. In theory, you can cook up any combination you want (e.g., UT system schools).</p>
<div id="459607bb" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>all_params <span class="op">=</span> {</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>        <span class="st">"UT Austin"</span>: params_tdr_ut_austin,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Baylor"</span>: params_tdr_baylor,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"SMU"</span>: params_tdr_smu,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"TAMU"</span>: params_tdr_tamu,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Texas State"</span>: params_tdr_txst,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Texas Tech"</span>: params_tdr_ttu,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Houston"</span>: params_tdr_houston,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"HSC Fort Worth"</span>: params_tdr_hscfw,</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"TAMU Galveston"</span>: params_tdr_tamug,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"TAMU International"</span>: params_tdr_tamui,</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"UT San Antonio Health"</span>: params_tdr_utsah,</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"UT Southwestern Medical"</span>: params_tdr_utswm,</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"UT Arlington"</span>: params_tdr_uta,</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Texas Women's University"</span>: params_tdr_twu</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>tamu_combined_params <span class="op">=</span> {</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"TAMU"</span>: params_tdr_tamu,</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"TAMU Galveston"</span>: params_tdr_tamug,</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"TAMU International"</span>: params_tdr_tamui</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The next codebook then uses ‘if-else’ statements to tell the script which combination (or single-institution parameter set) to use. The script is basically saying:</p>
<ul>
<li>if you set the <em>onlyMyInstitution</em> toggle to TRUE, AND you set the <em>my_institution_shortName</em> to “TAMU,” then I will use the combined TAMU parameter set (<em>tamu_combined_params</em>).</li>
<li>if you set the <em>onlyMyInstitution</em> toggle to TRUE, BUT you set the <em>my_institution_shortName</em> to anything other than “TAMU,” then I will use the single institution parameter set (e.g., <em>params_tdr_ut_austin</em> for UT Austin).</li>
<li>if you set the <em>onlyMyInstitution</em> toggle to FALSE, then I will search across all institutions with <em>all_params</em>.</li>
</ul>
<div id="8a0ef4b6" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">#substitute for your institution</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> onlyMyInstitution:</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> my_institution_shortName <span class="op">==</span> <span class="st">"TAMU"</span>:</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>        params_list <span class="op">=</span> tamu_combined_params</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>        params_list <span class="op">=</span> {</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>            my_institution_shortName: all_params[my_institution_shortName]</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    params_list <span class="op">=</span> all_params</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="functions" class="level3">
<h3 class="anchored" data-anchor-id="functions">Functions</h3>
<p>Functions are used when you need to apply the same logic many times throughout a script; it can make the process more concise rather than having to repeat tens to hundreds of lines of code. To be honest, the functions below are pretty technical and are the result of a lot of experimentation with many APIs. You should not touch them unless you know what you are doing, but feel free to ask questions if you want to know what a given line is doing. As a note, even though some functions’ names might suggest they are designed only for querying all institutions (e.g., <em>retrieve_all_data_for_institutions</em>), if you are only running this for a single institution or a subset of institutions, it will still work the same.</p>
<div id="40018b97" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#define functions</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co">##function to get single page from Dataverse API</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> retrieve_page_dataverse(url, params<span class="op">=</span><span class="va">None</span>, headers<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> requests.get(url, params<span class="op">=</span>params, headers<span class="op">=</span>headers)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>        response.raise_for_status()</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response.json()</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> requests.RequestException <span class="im">as</span> e:</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error retrieving page: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">'data'</span>: {<span class="st">'items'</span>: [], <span class="st">'total_count'</span>: <span class="dv">0</span>}}</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co">##function to get many pages from Dataverse API</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> retrieve_all_data_dataverse(url, params, headers):</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> page_limit_dataverse, k</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create empty list</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    all_data_tdr <span class="op">=</span> []</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="va">True</span> <span class="kw">and</span> k <span class="op">&lt;</span> page_limit_dataverse: </span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>        k<span class="op">+=</span><span class="dv">1</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> retrieve_page_dataverse(url, params, headers)  </span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        total_count <span class="op">=</span> data[<span class="st">'data'</span>][<span class="st">'total_count'</span>]</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>        total_pages <span class="op">=</span> math.ceil(total_count<span class="op">/</span>page_limit_dataverse)</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Retrieving Page </span><span class="sc">{</span>params[<span class="st">'page'</span>]<span class="sc">}</span><span class="ss"> of </span><span class="sc">{</span>total_pages<span class="sc">}</span><span class="ss"> pages...</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> data[<span class="st">'data'</span>]:</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"No data found."</span>)</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>        all_data_tdr.extend(data[<span class="st">'data'</span>][<span class="st">'items'</span>])</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">#update pagination</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>        params[<span class="st">'start'</span>] <span class="op">+=</span> page_limit_dataverse</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>        params[<span class="st">'page'</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> params[<span class="st">'start'</span>] <span class="op">&gt;=</span> total_count:</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"End of response."</span>)</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> all_data_tdr</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a><span class="co">##function to retrieve many pages from many institutions</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> retrieve_all_data_for_institutions(url, params_list, headers):</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>    all_data <span class="op">=</span> []</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> institution_name, params <span class="kw">in</span> params_list.items():</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>        <span class="kw">global</span> page_limit_dataverse, k</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>        k <span class="op">=</span> <span class="dv">0</span>  <span class="co">#reset k for each institution</span></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>        all_data_tdr <span class="op">=</span> retrieve_all_data_dataverse(url, params, headers)</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> entry <span class="kw">in</span> all_data_tdr:</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>            entry[<span class="st">'institution'</span>] <span class="op">=</span> institution_name </span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>            all_data.append(entry)</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> all_data</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a><span class="co">##function to count descriptive words</span></span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_words(text):</span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>    words <span class="op">=</span> text.split()</span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>    total_words <span class="op">=</span> <span class="bu">len</span>(words)</span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>    descriptive_count <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> word <span class="kw">in</span> words <span class="cf">if</span> word <span class="kw">not</span> <span class="kw">in</span> nondescriptive_words)</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> total_words, descriptive_count</span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a><span class="co">##function to account for when a single word may or may not be descriptive but is certainly uninformative if in a certain combination</span></span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> adjust_descriptive_count(row):</span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="st">'supplemental material'</span> <span class="kw">in</span> row[<span class="st">'titleReformatted'</span>].lower() <span class="kw">or</span></span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a>            <span class="st">'supplementary material'</span> <span class="kw">in</span> row[<span class="st">'titleReformatted'</span>].lower() <span class="kw">or</span></span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>            <span class="st">'supplementary materials'</span> <span class="kw">in</span> row[<span class="st">'titleReformatted'</span>].lower() <span class="kw">or</span></span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>            <span class="st">'supplemental materials'</span> <span class="kw">in</span> row[<span class="st">'titleReformatted'</span>].lower()):</span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">max</span>(<span class="dv">0</span>, row[<span class="st">'descriptiveWordCount_title'</span>] <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> row[<span class="st">'descriptiveWordCount_title'</span>]</span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a><span class="co">##function to assign size bins (file or dataset level)</span></span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assign_size_bins(df, column<span class="op">=</span><span class="st">'fileSize'</span>, new_column<span class="op">=</span><span class="st">'fileSizeBin'</span>):</span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a>    df<span class="op">=</span>df.copy()</span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a>    bins <span class="op">=</span> [</span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">0</span>, <span class="dv">1</span> <span class="op">*</span> <span class="dv">1024</span>, <span class="st">"0-10 kB"</span>),</span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">1</span> <span class="op">*</span> <span class="dv">1024</span>, <span class="dv">1</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>, <span class="st">"10 kB-1 MB"</span>),</span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">1</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>, <span class="dv">100</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>, <span class="st">"1-100 MB"</span>),</span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">100</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>, <span class="dv">1</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>, <span class="st">"100 MB-1 GB"</span>),</span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">1</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>, <span class="dv">10</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>, <span class="st">"1-10 GB"</span>),</span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">10</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>, <span class="dv">15</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>, <span class="st">"10-15 GB"</span>),</span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">15</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>, <span class="dv">20</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>, <span class="st">"15-20 GB"</span>),</span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">20</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>, <span class="dv">25</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>, <span class="st">"20-25 GB"</span>),</span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">25</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>, <span class="dv">30</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>, <span class="st">"25-30 GB"</span>),</span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">30</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>, <span class="dv">40</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>, <span class="st">"30-40 GB"</span>),</span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">40</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>, <span class="dv">50</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>, <span class="st">"40-50 GB"</span>),</span>
<span id="cb22-87"><a href="#cb22-87" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb22-88"><a href="#cb22-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-89"><a href="#cb22-89" aria-hidden="true" tabindex="-1"></a>    <span class="co">#default set to empty</span></span>
<span id="cb22-90"><a href="#cb22-90" aria-hidden="true" tabindex="-1"></a>    df[new_column] <span class="op">=</span> <span class="st">"Empty"</span></span>
<span id="cb22-91"><a href="#cb22-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> lower, upper, label <span class="kw">in</span> bins:</span>
<span id="cb22-92"><a href="#cb22-92" aria-hidden="true" tabindex="-1"></a>        df.loc[(df[column] <span class="op">&gt;</span> lower) <span class="op">&amp;</span> (df[column] <span class="op">&lt;=</span> upper), new_column] <span class="op">=</span> label</span>
<span id="cb22-93"><a href="#cb22-93" aria-hidden="true" tabindex="-1"></a>    <span class="co">#maximum bin</span></span>
<span id="cb22-94"><a href="#cb22-94" aria-hidden="true" tabindex="-1"></a>    df.loc[df[column] <span class="op">&gt;</span> <span class="dv">50</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>, new_column] <span class="op">=</span> <span class="st">"&gt;50 GB"</span></span>
<span id="cb22-95"><a href="#cb22-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-96"><a href="#cb22-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="retrieval-process-part-1" class="level2">
<h2 class="anchored" data-anchor-id="retrieval-process-part-1">Retrieval process: part 1</h2>
<p>Because we defined a series of functions related to retrieving records from the Dataverse API, potentially across all institutions, the process to trigger the API call is a single line, as seen below.</p>
<div id="ba4c6459" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Starting TDR retrieval.</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>all_data <span class="op">=</span> retrieve_all_data_for_institutions(url_tdr, params_list, headers_tdr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Starting TDR retrieval.

Retrieving Page 1 of 152 pages...

Retrieving Page 2 of 152 pages...

Retrieving Page 3 of 152 pages...

Retrieving Page 4 of 152 pages...

Retrieving Page 5 of 152 pages...

Retrieving Page 6 of 152 pages...

Retrieving Page 7 of 152 pages...

Retrieving Page 8 of 152 pages...

Retrieving Page 9 of 152 pages...

Retrieving Page 10 of 152 pages...
</code></pre>
</div>
</div>
<section id="subsetting-api-response" class="level3">
<h3 class="anchored" data-anchor-id="subsetting-api-response">Subsetting API response</h3>
<p>After the call, the API response is cached in the system but not saved in any form. You could, if you wanted to, export it as a JSON file, but I prefer working in CSV / tabular format for a lot of this work, so we’ll convert it to a dataframe first. The first step in that is selecting certain fields that we want; not all fields are useful.</p>
<p><strong>Why not just explode each JSON field into a separate Excel column (e.g., <em>authors</em> becomes <em>authors_1</em>, <em>authors_2</em>, etc.)?</strong></p>
<p>I actually used to do this when I was developing another Python workflow (https://github.com/utlibraries/research-data-discovery). What I discovered is that, given any appreciable number of dataset records (let’s say more than 250), at least one is virtually guaranteed to have an inordinate number of nested fields (e.g., 29 authors). This means that the script will flatten just that one field into 29 columns, which takes a lot longer to do and a lot longer to work through. If you start getting up above 1,000 records, you might not have enough RAM to actually do this. When we know what fields are important, we can just subset for them.</p>
<p><strong>Why are we subsetting so few fields?</strong></p>
<p>The Search API endpoint returns relatively little metadata because it’s intended for a broad capture (one call, many results). It doesn’t even return information like author affiliations. So the main purpose of this call is just to get every single dataset of interest, and then we’ll pass the DOIs into a different API endpoint to get more detailed metadata.</p>
<p>The way that this first subsetting process works is to create an empty list to hold the subsetted output (<em>data_select_tdr</em>) and then to loop through the full API response (<em>all_data</em>), pulling out specific fields. The syntax (e.g., <em>item.get</em>) is based on the hierarchy of the output. You’ll see in later processes how we’ll need to extract more nested objects. The script then appends each dataset’s subsetted metadata into the list, and we convert it to a dataframe with the <em>pandas</em> library.</p>
<div id="6f50cfe4" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Starting TDR filtering.</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>data_select_tdr <span class="op">=</span> []</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> item <span class="kw">in</span> all_data:</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span> <span class="op">=</span> item.get(<span class="st">'global_id'</span>, <span class="st">''</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> <span class="op">=</span> item.get(<span class="st">'type'</span>, <span class="st">''</span>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    institution <span class="op">=</span> item.get(<span class="st">'institution'</span>,<span class="st">''</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    status <span class="op">=</span> item.get(<span class="st">'versionState'</span>, <span class="st">''</span>)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> item.get(<span class="st">'name'</span>, <span class="st">''</span>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    dataverse <span class="op">=</span> item.get(<span class="st">'name_of_dataverse'</span>, <span class="st">''</span>)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    majorV <span class="op">=</span> item.get(<span class="st">'majorVersion'</span>, <span class="dv">0</span>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    minorV <span class="op">=</span> item.get(<span class="st">'minorVersion'</span>, <span class="dv">0</span>)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    comboV <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>majorV<span class="sc">}</span><span class="ss">.</span><span class="sc">{</span>minorV<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    data_select_tdr.append({</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">'institution'</span>: institution, </span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">'doi'</span>: <span class="bu">id</span>,</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">'type'</span>: <span class="bu">type</span>,</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">'status'</span>: status,</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">'title'</span>: name,</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">'dataverse'</span>: dataverse,</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">'majorVersion'</span>: majorV,</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">'minorVersion'</span>: minorV,</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">'totalVersion'</span>: comboV</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>df_data_select_tdr <span class="op">=</span> pd.DataFrame(data_select_tdr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Starting TDR filtering.
</code></pre>
</div>
</div>
<section id="post-conversion-cleaning" class="level4">
<h4 class="anchored" data-anchor-id="post-conversion-cleaning">Post-conversion cleaning</h4>
<p>We’ll do a little bit of cleaning / modification of the data now that they’re in a dataframe. The first step (filtering for ‘type’ = ‘dataset’) is redundant now because the ‘type’ is specified in the API call (this omits retrieval of ‘dataverse’ and ‘file’ records), but it’s retained because it doesn’t take up any more time and can be useful if you change the parameters later. The two other steps edit the DOI field to remove a ‘doi:’ string that always precedes the DOI value in that column and to add a Boolean column indicating whether a dataset has been versioned or not.</p>
<div id="1621bd6f" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">#remove dataverses and files</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>filtered_tdr <span class="op">=</span> df_data_select_tdr[df_data_select_tdr[<span class="st">'type'</span>] <span class="op">==</span> <span class="st">'dataset'</span>]</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co">#editing DOI field</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>filtered_tdr[<span class="st">'doi'</span>] <span class="op">=</span> filtered_tdr[<span class="st">'doi'</span>].<span class="bu">str</span>.replace(<span class="st">'doi:'</span>, <span class="st">''</span>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co">#add column for versioned</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>filtered_tdr[<span class="st">'versioned'</span>] <span class="op">=</span> filtered_tdr.<span class="bu">apply</span>(<span class="kw">lambda</span> row: <span class="st">'Versioned'</span> <span class="cf">if</span> (row[<span class="st">'majorVersion'</span>] <span class="op">&gt;</span> <span class="dv">1</span>) <span class="kw">or</span> (row[<span class="st">'minorVersion'</span>] <span class="op">&gt;</span> <span class="dv">0</span>) <span class="cf">else</span> <span class="st">'Not versioned'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="metadata-assessment-part-1" class="level3">
<h3 class="anchored" data-anchor-id="metadata-assessment-part-1">Metadata assessment: part 1</h3>
<p>We can’t really do too much metadata assessment at the dataset/file level because of the limited metadata we get from the Search API. We can do one though: how descriptive are dataset titles? This pulls in a list of nondescriptive words from the <em>config.json</em> file (you can modify these if you wish) and then looks through the title to count how many other words remain. This operates on a few combinations of words as well (<em>adjust_descriptive_count</em> function) where the individual words aren’t necessarily nondescriptive in isolation but are when combined (e.g., ‘supplemental information’). Titles are formatted to remove underscores and hyphens, otherwise the entire string gets treated as one word.</p>
<div id="3ab339fc" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">#metadata assessments</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co">##title</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co">##assess 'descriptiveness of dataset title'</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>words <span class="op">=</span> config[<span class="st">'WORDS'</span>]</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co">###add integers</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>numbers <span class="op">=</span> <span class="bu">list</span>(<span class="bu">map</span>(<span class="bu">str</span>, <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">1000000</span>)))</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co">###combine all into a single set</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>nondescriptive_words <span class="op">=</span> <span class="bu">set</span>(</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    words[<span class="st">'articles'</span>] <span class="op">+</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    words[<span class="st">'conjunctions'</span>] <span class="op">+</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    words[<span class="st">'prepositions'</span>] <span class="op">+</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    words[<span class="st">'auxiliary_verbs'</span>] <span class="op">+</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    words[<span class="st">'possessives'</span>] <span class="op">+</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    words[<span class="st">'descriptors'</span>] <span class="op">+</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    words[<span class="st">'order'</span>] <span class="op">+</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    words[<span class="st">'version'</span>] <span class="op">+</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    numbers</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>filtered_tdr[<span class="st">'titleReformatted'</span>] <span class="op">=</span> filtered_tdr[<span class="st">'title'</span>].<span class="bu">str</span>.replace(<span class="st">'_'</span>, <span class="st">' '</span>) </span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>filtered_tdr[<span class="st">'titleReformatted'</span>] <span class="op">=</span> filtered_tdr[<span class="st">'title'</span>].<span class="bu">str</span>.replace(<span class="st">'-'</span>, <span class="st">' '</span>) <span class="co">#gets around text linked by underscores counting as 1 word</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>filtered_tdr[<span class="st">'titleReformatted'</span>] <span class="op">=</span> filtered_tdr[<span class="st">'titleReformatted'</span>].<span class="bu">str</span>.lower()</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>filtered_tdr[[<span class="st">'totalWordCount_title'</span>, <span class="st">'descriptiveWordCount_title'</span>]] <span class="op">=</span> filtered_tdr[<span class="st">'titleReformatted'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series(count_words(x)))</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>filtered_tdr[<span class="st">'descriptiveWordCount_title'</span>] <span class="op">=</span> filtered_tdr.<span class="bu">apply</span>(adjust_descriptive_count, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>filtered_tdr[<span class="st">'nondescriptiveWordCount_title'</span>] <span class="op">=</span> filtered_tdr[<span class="st">'totalWordCount_title'</span>] <span class="op">-</span> filtered_tdr[<span class="st">'descriptiveWordCount_title'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="retrieval-process-part-2" class="level2">
<h2 class="anchored" data-anchor-id="retrieval-process-part-2">Retrieval process: part 2</h2>
<p>The next part of the process is where we get richer metadata. In this step, we go through the <a href="https://guides.dataverse.org/en/latest/api/native-api.html">Native API</a>. This endpoint requires you to feed a single DOI into it, and then it returns very detailed, file-level metadata for the latest version of the dataset (regardless of publication status).</p>
<p>First, however, we need to deal with a quirk of the Search API: that it returns two records for any dataset that has been previously published and that is now in draft status. These records could be functionally identical (e.g., author accidentally puts published dataset into draft mode, strands it there without making changes) or quite significantly different. The code below de-duplicates these records, retaining only the published version, but saves a CSV file with a list of pairs of records with this status.</p>
<div id="ef508fc9" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co">#sort on status, setting 'DRAFT' at bottom to remove this version for published datasets that are in draft state, retain entry of 'PUBLISHED'</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>filtered_tdr <span class="op">=</span> filtered_tdr.sort_values(by<span class="op">=</span><span class="st">'status'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>filtered_tdr.to_csv(<span class="ss">f"outputs/</span><span class="sc">{</span>todayDate<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>institutionFilename<span class="sc">}</span><span class="ss">_all-deposits.csv"</span>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>filtered_tdr_deduplicated <span class="op">=</span> filtered_tdr.drop_duplicates(subset<span class="op">=</span>[<span class="st">'doi'</span>], keep<span class="op">=</span><span class="st">"first"</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>filtered_tdr_deduplicated.to_csv(<span class="ss">f"outputs/</span><span class="sc">{</span>todayDate<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>institutionFilename<span class="sc">}</span><span class="ss">_all-deposits-deduplicated.csv"</span>)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Total datasets to be analyzed: </span><span class="sc">{</span><span class="bu">len</span>(filtered_tdr_deduplicated)<span class="sc">}</span><span class="ss">.</span><span class="ch">\n</span><span class="ss">'</span>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co">#create df of published datasets with draft version (retains both entries)</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>commonColumns <span class="op">=</span> [<span class="st">'doi'</span>, <span class="st">'title'</span>]</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>duplicates <span class="op">=</span> filtered_tdr.duplicated(subset<span class="op">=</span>commonColumns, keep<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>dualStatusDatasets <span class="op">=</span> filtered_tdr[duplicates]</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>dualStatusDatasets.to_csv(<span class="ss">f"outputs/</span><span class="sc">{</span>todayDate<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>institutionFilename<span class="sc">}</span><span class="ss">_dual-status-datasets.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Total datasets to be analyzed: 100.
</code></pre>
</div>
</div>
<p>Now we have a list of unique DOIs that we want more metadata on. The following code makes a similar API call to the first one, but through the Native API endpoint. So we define the endpoint (it’s a different URL) and then set up a ‘for loop,’ where we go through each DOI in the de-duplicated dataframe, get its metadata, and save that in an empty list called <em>results</em>.</p>
<div id="af9925f9" class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">#retrieving additional metadata for deposits by individual API call (one per DOI)</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co">##retrieves both published and never-published draft datasets; if a published dataset is currently in DRAFT state, it will return the information for the DRAFT state</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Starting Native API call"</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>url_tdr_native <span class="op">=</span> <span class="st">"https://dataverse.tdl.org/api/datasets/"</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> []</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> doi <span class="kw">in</span> filtered_tdr_deduplicated[<span class="st">'doi'</span>]:</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> requests.get(<span class="ss">f'</span><span class="sc">{</span>url_tdr_native<span class="sc">}</span><span class="ss">:persistentId/?persistentId=doi:</span><span class="sc">{</span>doi<span class="sc">}</span><span class="ss">'</span>, headers<span class="op">=</span>headers_tdr, timeout<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Retrieving </span><span class="sc">{</span>doi<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>            results.append(response.json())</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error retrieving </span><span class="sc">{</span>doi<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>response<span class="sc">.</span>status_code<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>response<span class="sc">.</span>text<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> requests.exceptions.RequestException <span class="im">as</span> e:</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Timeout error on DOI </span><span class="sc">{</span>doi<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>data_tdr_native <span class="op">=</span> {</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'datasets'</span>: results</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we do a similar subsetting process to what we did for the first API call. We make an empty list to store the output (<em>data_select_tdr_native</em>) and then loop through. You might notice that there are various <em>X.get</em> commands in the script below. This is based on the nesting of different fields. For example, <em>latest</em> is nested within <em>data</em>, so in order to get anything that is nested under <em>latest</em>, we need to define that one first. The only way to know how to structure this is to look at an actual API response. You’ll see that we’re subsetting a lot more fields and getting a lot more detail in the metadata. This code specifically creates an entry for each file listed in a dataset record, so some dataset-level metadata is duplicated across several rows.</p>
<div id="f5257e97" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Beginning dataframe subsetting</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>data_select_tdr_native <span class="op">=</span> [] </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> item <span class="kw">in</span> data_tdr_native[<span class="st">'datasets'</span>]:</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> item.get(<span class="st">'data'</span>, <span class="st">''</span>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    datasetID <span class="op">=</span> data.get(<span class="st">'id'</span>, <span class="st">''</span>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    pubDate <span class="op">=</span> data.get(<span class="st">'publicationDate'</span>, <span class="st">''</span>)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    latest <span class="op">=</span> data.get(<span class="st">'latestVersion'</span>, {})</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    status <span class="op">=</span> latest.get(<span class="st">'versionState'</span>, <span class="st">''</span>)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    status2 <span class="op">=</span> latest.get(<span class="st">'latestVersionPublishingState'</span>, <span class="st">''</span>)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    doi <span class="op">=</span> latest.get(<span class="st">'datasetPersistentId'</span>, <span class="st">''</span>)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    updateDate <span class="op">=</span> latest.get(<span class="st">'lastUpdateTime'</span>, <span class="st">''</span>)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    createDate <span class="op">=</span> latest.get(<span class="st">'createTime'</span>, <span class="st">''</span>)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    releaseDate <span class="op">=</span> latest.get(<span class="st">'releaseTime'</span>, <span class="st">''</span>)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    license <span class="op">=</span> latest.get(<span class="st">'license'</span>, {})</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    licenseName <span class="op">=</span> license.get(<span class="st">'name'</span>, <span class="va">None</span>)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    terms <span class="op">=</span> latest.get(<span class="st">'termsOfUse'</span>, <span class="va">None</span>)</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    usage <span class="op">=</span> licenseName <span class="cf">if</span> licenseName <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> terms</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    files <span class="op">=</span> latest.get(<span class="st">'files'</span>, [])</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    citation <span class="op">=</span> latest.get(<span class="st">'metadataBlocks'</span>, {}).get(<span class="st">'citation'</span>, {})</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    fields <span class="op">=</span> citation.get(<span class="st">'fields'</span>, [])</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    grantAgencies <span class="op">=</span> []</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> field <span class="kw">in</span> fields:</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> field[<span class="st">'typeName'</span>] <span class="op">==</span> <span class="st">'grantNumber'</span>:</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> grant <span class="kw">in</span> field.get(<span class="st">'value'</span>, []):</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>                grant_number_agency <span class="op">=</span> grant.get(<span class="st">'grantNumberAgency'</span>, {}).get(<span class="st">'value'</span>, <span class="st">''</span>)</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>                grantAgencies.append(grant_number_agency)</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>    total_filesize <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>    unique_content_types <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>    fileCount <span class="op">=</span> <span class="bu">len</span>(files)</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> file_info <span class="kw">in</span> files:</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>        file_data <span class="op">=</span> file_info[<span class="st">'dataFile'</span>]</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>        unique_content_types.add(file_data[<span class="st">'contentType'</span>])</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>        file_entry <span class="op">=</span> {</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>            <span class="st">'datasetID'</span>: datasetID,</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>            <span class="st">'doi'</span>: doi,</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>            <span class="co">#'status': status,</span></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>            <span class="st">'currentStatus'</span>: status2,</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>            <span class="st">'reuseRequirements'</span>: usage,</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>            <span class="co">#'fileCount': fileCount,</span></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>            <span class="co">#'unique_content_types': list(unique_content_types),</span></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>            <span class="st">'fileID'</span>: file_data.get(<span class="st">'id'</span>, <span class="st">''</span>),</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>            <span class="st">'public'</span>: file_data.get(<span class="st">'restricted'</span>, <span class="st">''</span>),</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>            <span class="st">'filename'</span>: file_data.get(<span class="st">'filename'</span>, <span class="st">''</span>),</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mimeType'</span>: file_data.get(<span class="st">'contentType'</span>, <span class="st">''</span>),</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>            <span class="st">'friendlyType'</span>: file_data.get(<span class="st">'friendlyType'</span>, <span class="st">''</span>),</span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>            <span class="st">'tabular'</span>: file_data.get(<span class="st">'tabularData'</span>, <span class="st">''</span>),</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>            <span class="st">'fileSize'</span>: file_data.get(<span class="st">'filesize'</span>, <span class="dv">0</span>),</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>            <span class="st">'storageIdentifier'</span>: file_data.get(<span class="st">'storageIdentifier'</span>, <span class="st">''</span>),</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>            <span class="st">'creationDate'</span>: file_data.get(<span class="st">'creationDate'</span>, <span class="st">''</span>),</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>            <span class="st">'publicationDate'</span>: file_data.get(<span class="st">'publicationDate'</span>, <span class="st">''</span>)</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>        data_select_tdr_native.append(file_entry)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Beginning dataframe subsetting
</code></pre>
</div>
</div>
<p>We’re also going to create a different subsetted output from the same API response, this one for individual authors (you can create as many subsetted outputs as you want from a single API response). This one creates a separate entry for each author listed in a dataset record, so some dataset-level metadata is duplicated across several rows. This one has to deal with some extra complexity in how Dataverse structures entries that have ROR IDs vs.&nbsp;ones that don’t.</p>
<div id="72d394d2" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">#getting dataframe with entries for individual authors</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>author_entries <span class="op">=</span> []</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> item <span class="kw">in</span> data_tdr_native[<span class="st">'datasets'</span>]:</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> item.get(<span class="st">'data'</span>, {})</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    latest <span class="op">=</span> data.get(<span class="st">'latestVersion'</span>, {})</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    doi <span class="op">=</span> latest.get(<span class="st">'datasetPersistentId'</span>, <span class="st">''</span>)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    citation <span class="op">=</span> latest.get(<span class="st">'metadataBlocks'</span>, {}).get(<span class="st">'citation'</span>, {})</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    status2 <span class="op">=</span> latest.get(<span class="st">'latestVersionPublishingState'</span>, <span class="st">''</span>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    fields <span class="op">=</span> citation.get(<span class="st">'fields'</span>, [])</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> field <span class="kw">in</span> fields:</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> field[<span class="st">'typeName'</span>] <span class="op">==</span> <span class="st">'author'</span>:</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> author <span class="kw">in</span> field.get(<span class="st">'value'</span>, []):</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>                name <span class="op">=</span> author.get(<span class="st">'authorName'</span>, {}).get(<span class="st">'value'</span>, <span class="st">''</span>)</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>                affiliation <span class="op">=</span> author.get(<span class="st">'authorAffiliation'</span>, {}).get(<span class="st">'value'</span>, <span class="st">''</span>)</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>                identifier <span class="op">=</span> author.get(<span class="st">'authorIdentifier'</span>, {}).get(<span class="st">'value'</span>, <span class="st">''</span>)</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>                scheme <span class="op">=</span> author.get(<span class="st">'authorIdentifierScheme'</span>, {}).get(<span class="st">'value'</span>, <span class="st">''</span>)</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>                affiliation_expanded <span class="op">=</span> author.get(<span class="st">'authorAffiliation'</span>, {}).get(<span class="st">'expandedvalue'</span>, {}).get(<span class="st">'termName'</span>, <span class="st">''</span>)</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>                identifier_expanded <span class="op">=</span> author.get(<span class="st">'authorIdentifier'</span>, {}).get(<span class="st">'expandedvalue'</span>, {}).get(<span class="st">'@id'</span>, <span class="st">''</span>)</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>                affiliationName <span class="op">=</span> affiliation_expanded <span class="cf">if</span> affiliation_expanded <span class="cf">else</span> affiliation</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>                affiliation_ror <span class="op">=</span> affiliation <span class="cf">if</span> affiliation_expanded <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>                author_entry <span class="op">=</span> {</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'doi'</span>: doi,</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'currentStatus'</span>: status2,</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'authorName'</span>: name,</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'authorAffiliation'</span>: affiliationName,</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'rorID'</span>: affiliation_ror,</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'authorIdentifier'</span>: identifier,</span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'authorIdentifierExpanded'</span>: identifier_expanded,</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'authorIdentifierScheme'</span>: scheme</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>                author_entries.append(author_entry)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="initial-cleaning" class="level3">
<h3 class="anchored" data-anchor-id="initial-cleaning">Initial cleaning</h3>
<p>We then convert these subsetted responses to dataframes, standardize how the DOIs are listed, and add a column for the file-level output to create a column with just the year the file was created (from a full date).</p>
<div id="97824c33" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>df_select_tdr_native <span class="op">=</span> pd.json_normalize(data_select_tdr_native)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>df_author_entries <span class="op">=</span> pd.json_normalize(author_entries)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>df_select_tdr_native[<span class="st">'doi'</span>] <span class="op">=</span> df_select_tdr_native[<span class="st">'doi'</span>].<span class="bu">str</span>.replace(<span class="st">'doi:'</span>, <span class="st">''</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>df_author_entries[<span class="st">'doi'</span>] <span class="op">=</span> df_author_entries[<span class="st">'doi'</span>].<span class="bu">str</span>.replace(<span class="st">'doi:'</span>, <span class="st">''</span>)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>df_select_tdr_native[<span class="st">'creationDate'</span>] <span class="op">=</span> pd.to_datetime(df_select_tdr_native[<span class="st">'creationDate'</span>])</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>df_select_tdr_native[<span class="st">'fileCreationYear'</span>] <span class="op">=</span> df_select_tdr_native[<span class="st">'creationDate'</span>].dt.year</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="metadata-assessment-part-2" class="level3">
<h3 class="anchored" data-anchor-id="metadata-assessment-part-2">Metadata assessment: part 2</h3>
<p>We do another metadata assessment at this point: binning files by their size (<em>size_bin</em>). This dataframe is then merged back with the dataframe from the Search API.</p>
<div id="8b73f4f1" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>df_select_tdr_native <span class="op">=</span> assign_size_bins(df_select_tdr_native, column<span class="op">=</span><span class="st">'fileSize'</span>, new_column<span class="op">=</span><span class="st">'fileSizeBin'</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>df_select_concatenated <span class="op">=</span> pd.merge(filtered_tdr_deduplicated, df_select_tdr_native, on<span class="op">=</span><span class="st">'doi'</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>df_select_concatenated_exist <span class="op">=</span> df_select_concatenated.dropna(subset<span class="op">=</span>[<span class="st">'datasetID'</span>]).copy() <span class="co">#removes deaccessioned</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>df_select_concatenated_exist[<span class="st">'datasetID'</span>] <span class="op">=</span> df_select_concatenated_exist[<span class="st">'datasetID'</span>].astype(<span class="bu">int</span>)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>df_select_concatenated_exist.to_csv(<span class="ss">f"outputs/</span><span class="sc">{</span>todayDate<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>institutionFilename<span class="sc">}</span><span class="ss">_all-deposits-deduplicated_expanded-metadata.csv"</span>)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="co">#subset to datasets that are less than version 2.0 (no major update, no file additions)</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>df_select_concatenated_exist_majorVersion <span class="op">=</span> df_select_concatenated_exist[df_select_concatenated_exist[<span class="st">'majorVersion'</span>] <span class="op">&gt;</span> <span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="retrieval-process-part-3" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-process-part-3">Retrieval process: part 3</h3>
<p>This final API call is optional (<em>versionsAPI</em> toggle). If you set that to FALSE, this entire codeblock will be skipped. If you run it, the process and metadata are nearly identical to that of the previous Native API call; the <a href="https://guides.dataverse.org/en/latest/api/native-api.html">Versions</a> endpoint is technically part of the Native API, but it works a little differently. Firstly, this endpoint is public, so it will not return any metadata on drafts of any form (drafts of previously published, drafts of never published). Secondly, it returns metadata on all published versions of a dataset (the default Native endpoint only returns the most recent version). Whether the information of older published versions will significantly impact the results is a personal decision, and you may wish to experiment with it. The resultant output is subsetted and de-duplicated to handle predicted redundancy (e.g., a file present in versions 1 through 3 will have three entries), has the dataset size bin classification applied, and then aligns the columns to be the same as that of the previous outputs. This is done for both file-level output and author-level output.</p>
<div id="5319a891" class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">#need to use Version endpoint to get info on published version of published datasets that are currently in DRAFT status and all published versions of a dataset with multiple PUBLISHED versions. This endpoint is public and does not return any DRAFTs.</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="co">#remove datasets that have never been published (will not return any info for this endpoint)</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>df_select_concatenated_exist_published <span class="op">=</span> df_select_concatenated_exist_majorVersion[df_select_concatenated_exist_majorVersion[<span class="st">'publicationDate'</span>].notnull()]</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co">#deduplicate on datasetID</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>df_select_concatenated_exist_published_dedup <span class="op">=</span> df_select_concatenated_exist_published.drop_duplicates(subset<span class="op">=</span><span class="st">"datasetID"</span>, keep<span class="op">=</span><span class="st">"first"</span>)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> versionsAPI:</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    results_versions <span class="op">=</span> []</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Beginning Version API query</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> datasetID <span class="kw">in</span> df_select_concatenated_exist_published_dedup[<span class="st">'datasetID'</span>]:</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>            response <span class="op">=</span> requests.get(<span class="ss">f'</span><span class="sc">{</span>url_tdr_native<span class="sc">}{</span>datasetID<span class="sc">}</span><span class="ss">/versions'</span>)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Retrieving versions of dataset #</span><span class="sc">{</span>datasetID<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>()</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>                results_versions.append(response.json())</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Error retrieving dataset #</span><span class="sc">{</span>datasetID<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>response<span class="sc">.</span>status_code<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>response<span class="sc">.</span>text<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> requests.exceptions.RequestException <span class="im">as</span> e:</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Timeout error on DOI </span><span class="sc">{</span>doi<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>    data_tdr_versions <span class="op">=</span> {</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">'datasets'</span>: results_versions</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Beginning dataframe subsetting</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>    data_select_tdr_versions <span class="op">=</span> [] </span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> dataset <span class="kw">in</span> data_tdr_versions[<span class="st">'datasets'</span>]:</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> dataset.get(<span class="st">'data'</span>, [])</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> item <span class="kw">in</span> data:</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>            doi <span class="op">=</span> item.get(<span class="st">'datasetPersistentId'</span>, <span class="st">''</span>)</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>            <span class="bu">id</span> <span class="op">=</span> item.get(<span class="st">"id"</span>, <span class="st">''</span>)</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>            datasetid <span class="op">=</span> item.get(<span class="st">'datasetId'</span>, <span class="st">''</span>)</span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>            majorV <span class="op">=</span> <span class="bu">str</span>(item.get(<span class="st">'versionNumber'</span>, <span class="dv">0</span>))</span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>            minorV <span class="op">=</span> <span class="bu">str</span>(item.get(<span class="st">'versionMinorNumber'</span>, <span class="dv">0</span>))</span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>            status2 <span class="op">=</span> latest.get(<span class="st">'latestVersionPublishingState'</span>, <span class="st">''</span>)</span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>            comboV <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>majorV<span class="sc">}</span><span class="ss">.</span><span class="sc">{</span>minorV<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>            status <span class="op">=</span> item.get(<span class="st">'versionState'</span>, <span class="st">''</span>)</span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> item.get(<span class="st">'files'</span>, []):</span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a>                fileInfo <span class="op">=</span> <span class="bu">file</span>[<span class="st">'dataFile'</span>]</span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a>                data_select_tdr_versions.append({</span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'doi'</span>: doi,</span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'versionID'</span>: <span class="bu">id</span>,</span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'datasetID'</span>: datasetid,</span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>                    <span class="co">#'majorVersion': majorV,</span></span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a>                    <span class="co">#'minorVersion': minorV,</span></span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'totalVersion'</span>: comboV,</span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'fileID'</span>: fileInfo.get(<span class="st">'id'</span>, <span class="st">''</span>),</span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'filename'</span>: fileInfo.get(<span class="st">'filename'</span>, <span class="st">''</span>),</span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'mimeType'</span>: fileInfo.get(<span class="st">'contentType'</span>, <span class="st">''</span>),</span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'friendlyType'</span>: fileInfo.get(<span class="st">'friendlyType'</span>, <span class="st">''</span>),</span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a>                    <span class="co">#'status': status,</span></span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'currentStatus'</span>: status2,</span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a>                    <span class="co">#'tabular': fileInfo.get('tabularData', ''),</span></span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'fileSize'</span>: fileInfo.get(<span class="st">'filesize'</span>, <span class="st">''</span>),</span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'storageIdentifier'</span>: fileInfo.get(<span class="st">'storageIdentifier'</span>, <span class="st">''</span>),</span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a>                    <span class="co">#'md5': fileInfo.get('md5', ''),</span></span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'creationDate'</span>: fileInfo.get(<span class="st">'creationDate'</span>, <span class="st">''</span>),</span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'publicationDate'</span>: fileInfo.get(<span class="st">'publicationDate'</span>, <span class="st">''</span>)</span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true" tabindex="-1"></a>    <span class="co">#getting dataframe with entries for individual authors</span></span>
<span id="cb37-61"><a href="#cb37-61" aria-hidden="true" tabindex="-1"></a>    author_entries_versions <span class="op">=</span> []</span>
<span id="cb37-62"><a href="#cb37-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> dataset <span class="kw">in</span> data_tdr_versions[<span class="st">'datasets'</span>]:</span>
<span id="cb37-63"><a href="#cb37-63" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> dataset.get(<span class="st">'data'</span>, [])</span>
<span id="cb37-64"><a href="#cb37-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> item <span class="kw">in</span> data:</span>
<span id="cb37-65"><a href="#cb37-65" aria-hidden="true" tabindex="-1"></a>            doi <span class="op">=</span> item.get(<span class="st">'datasetPersistentId'</span>, <span class="st">''</span>)</span>
<span id="cb37-66"><a href="#cb37-66" aria-hidden="true" tabindex="-1"></a>            <span class="bu">id</span> <span class="op">=</span> item.get(<span class="st">"id"</span>, <span class="st">''</span>)</span>
<span id="cb37-67"><a href="#cb37-67" aria-hidden="true" tabindex="-1"></a>            status2 <span class="op">=</span> item.get(<span class="st">'latestVersionPublishingState'</span>, <span class="st">''</span>)</span>
<span id="cb37-68"><a href="#cb37-68" aria-hidden="true" tabindex="-1"></a>            datasetid <span class="op">=</span> item.get(<span class="st">'datasetId'</span>, <span class="st">''</span>)</span>
<span id="cb37-69"><a href="#cb37-69" aria-hidden="true" tabindex="-1"></a>            citation <span class="op">=</span> item.get(<span class="st">'metadataBlocks'</span>, {}).get(<span class="st">'citation'</span>, {})</span>
<span id="cb37-70"><a href="#cb37-70" aria-hidden="true" tabindex="-1"></a>            fields <span class="op">=</span> citation.get(<span class="st">'fields'</span>, [])</span>
<span id="cb37-71"><a href="#cb37-71" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> field <span class="kw">in</span> fields:</span>
<span id="cb37-72"><a href="#cb37-72" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> field[<span class="st">'typeName'</span>] <span class="op">==</span> <span class="st">'author'</span>:</span>
<span id="cb37-73"><a href="#cb37-73" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> author <span class="kw">in</span> field.get(<span class="st">'value'</span>, []):</span>
<span id="cb37-74"><a href="#cb37-74" aria-hidden="true" tabindex="-1"></a>                        name <span class="op">=</span> author.get(<span class="st">'authorName'</span>, {}).get(<span class="st">'value'</span>, <span class="st">''</span>)</span>
<span id="cb37-75"><a href="#cb37-75" aria-hidden="true" tabindex="-1"></a>                        affiliation <span class="op">=</span> author.get(<span class="st">'authorAffiliation'</span>, {}).get(<span class="st">'value'</span>, <span class="st">''</span>)</span>
<span id="cb37-76"><a href="#cb37-76" aria-hidden="true" tabindex="-1"></a>                        identifier <span class="op">=</span> author.get(<span class="st">'authorIdentifier'</span>, {}).get(<span class="st">'value'</span>, <span class="st">''</span>)</span>
<span id="cb37-77"><a href="#cb37-77" aria-hidden="true" tabindex="-1"></a>                        scheme <span class="op">=</span> author.get(<span class="st">'authorIdentifierScheme'</span>, {}).get(<span class="st">'value'</span>, <span class="st">''</span>)</span>
<span id="cb37-78"><a href="#cb37-78" aria-hidden="true" tabindex="-1"></a>                        affiliation_expanded <span class="op">=</span> author.get(<span class="st">'authorAffiliation'</span>, {}).get(<span class="st">'expandedvalue'</span>, {}).get(<span class="st">'termName'</span>, <span class="st">''</span>)</span>
<span id="cb37-79"><a href="#cb37-79" aria-hidden="true" tabindex="-1"></a>                        identifier_expanded <span class="op">=</span> author.get(<span class="st">'authorIdentifier'</span>, {}).get(<span class="st">'expandedvalue'</span>, {}).get(<span class="st">'@id'</span>, <span class="st">''</span>)</span>
<span id="cb37-80"><a href="#cb37-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-81"><a href="#cb37-81" aria-hidden="true" tabindex="-1"></a>                        affiliationName <span class="op">=</span> affiliation_expanded <span class="cf">if</span> affiliation_expanded <span class="cf">else</span> affiliation</span>
<span id="cb37-82"><a href="#cb37-82" aria-hidden="true" tabindex="-1"></a>                        affiliation_ror <span class="op">=</span> affiliation <span class="cf">if</span> affiliation_expanded <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb37-83"><a href="#cb37-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-84"><a href="#cb37-84" aria-hidden="true" tabindex="-1"></a>                        author_entry <span class="op">=</span> {</span>
<span id="cb37-85"><a href="#cb37-85" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'doi'</span>: doi,</span>
<span id="cb37-86"><a href="#cb37-86" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'currentStatus'</span>: status2,</span>
<span id="cb37-87"><a href="#cb37-87" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'authorName'</span>: name,</span>
<span id="cb37-88"><a href="#cb37-88" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'authorAffiliation'</span>: affiliationName,</span>
<span id="cb37-89"><a href="#cb37-89" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'rorID'</span>: affiliation_ror,</span>
<span id="cb37-90"><a href="#cb37-90" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'authorIdentifier'</span>: identifier,</span>
<span id="cb37-91"><a href="#cb37-91" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'authorIdentifierExpanded'</span>: identifier_expanded,</span>
<span id="cb37-92"><a href="#cb37-92" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'authorIdentifierScheme'</span>: scheme</span>
<span id="cb37-93"><a href="#cb37-93" aria-hidden="true" tabindex="-1"></a>                        }</span>
<span id="cb37-94"><a href="#cb37-94" aria-hidden="true" tabindex="-1"></a>                        author_entries_versions.append(author_entry)</span>
<span id="cb37-95"><a href="#cb37-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-96"><a href="#cb37-96" aria-hidden="true" tabindex="-1"></a>    df_select_tdr_versions <span class="op">=</span> pd.json_normalize(data_select_tdr_versions)</span>
<span id="cb37-97"><a href="#cb37-97" aria-hidden="true" tabindex="-1"></a>    df_author_entries_versions <span class="op">=</span> pd.json_normalize(author_entries_versions)</span>
<span id="cb37-98"><a href="#cb37-98" aria-hidden="true" tabindex="-1"></a>    df_select_tdr_versions[<span class="st">'doi'</span>] <span class="op">=</span> df_select_tdr_versions[<span class="st">'doi'</span>].<span class="bu">str</span>.replace(<span class="st">'doi:'</span>, <span class="st">''</span>)</span>
<span id="cb37-99"><a href="#cb37-99" aria-hidden="true" tabindex="-1"></a>    df_author_entries_versions[<span class="st">'doi'</span>] <span class="op">=</span> df_author_entries_versions[<span class="st">'doi'</span>].<span class="bu">str</span>.replace(<span class="st">'doi:'</span>, <span class="st">''</span>)</span>
<span id="cb37-100"><a href="#cb37-100" aria-hidden="true" tabindex="-1"></a>    <span class="co">#removing duplicate entries for a given file that has not changed across multiple versions</span></span>
<span id="cb37-101"><a href="#cb37-101" aria-hidden="true" tabindex="-1"></a>    df_select_tdr_versions[<span class="st">'totalVersion'</span>] <span class="op">=</span> df_select_tdr_versions[<span class="st">'totalVersion'</span>].astype(<span class="bu">float</span>)</span>
<span id="cb37-102"><a href="#cb37-102" aria-hidden="true" tabindex="-1"></a>    df_select_tdr_versions <span class="op">=</span> df_select_tdr_versions.sort_values(by<span class="op">=</span><span class="st">'totalVersion'</span>)</span>
<span id="cb37-103"><a href="#cb37-103" aria-hidden="true" tabindex="-1"></a>    df_select_tdr_versions_deduplicated <span class="op">=</span> df_select_tdr_versions.drop_duplicates(subset<span class="op">=</span>[<span class="st">'datasetID'</span>, <span class="st">'storageIdentifier'</span>], keep<span class="op">=</span><span class="st">'first'</span>)</span>
<span id="cb37-104"><a href="#cb37-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-105"><a href="#cb37-105" aria-hidden="true" tabindex="-1"></a>    df_select_tdr_versions_deduplicated <span class="op">=</span> assign_size_bins(df_select_tdr_versions_deduplicated, column<span class="op">=</span><span class="st">'fileSize'</span>, new_column<span class="op">=</span><span class="st">'fileSizeBin'</span>)</span>
<span id="cb37-106"><a href="#cb37-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-107"><a href="#cb37-107" aria-hidden="true" tabindex="-1"></a>    df_select_versions_concatenated_released <span class="op">=</span> pd.merge(df_select_tdr_versions_deduplicated, filtered_tdr_deduplicated, on<span class="op">=</span><span class="st">'doi'</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb37-108"><a href="#cb37-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-109"><a href="#cb37-109" aria-hidden="true" tabindex="-1"></a>    <span class="co">#pruning and renaming columns in the two dataframes that collectively (should) have all of the files (from the Native and the Version endpoints)</span></span>
<span id="cb37-110"><a href="#cb37-110" aria-hidden="true" tabindex="-1"></a>    df_version_pruned <span class="op">=</span> df_select_versions_concatenated_released[[<span class="st">"versionID"</span>, <span class="st">"datasetID"</span>, <span class="st">"totalVersion_x"</span>, <span class="st">"filename"</span>, <span class="st">"fileID"</span>, <span class="st">"mimeType"</span>, <span class="st">"friendlyType"</span>, <span class="st">"fileSize"</span>, <span class="st">"storageIdentifier"</span>, <span class="st">"creationDate"</span>, <span class="st">"publicationDate"</span>, <span class="st">"institution"</span>, <span class="st">"doi"</span>, <span class="st">"fileSizeBin"</span>, <span class="st">"title"</span>, <span class="st">"dataverse"</span>]]</span>
<span id="cb37-111"><a href="#cb37-111" aria-hidden="true" tabindex="-1"></a>    df_version_pruned <span class="op">=</span> df_version_pruned.rename(columns<span class="op">=</span>{<span class="st">'totalVersion_x'</span>: <span class="st">'totalVersion'</span>, <span class="st">'filename_x'</span>: <span class="st">'filename'</span>, <span class="st">'fileSize_x'</span>: <span class="st">'fileSize'</span>, <span class="st">'storageIdentifier_x'</span>: <span class="st">'storageIdentifier'</span>, <span class="st">'creationDate_x'</span>: <span class="st">'creationDate'</span>, <span class="st">'publicationDate_x'</span>:<span class="st">'publicationDate'</span>})</span>
<span id="cb37-112"><a href="#cb37-112" aria-hidden="true" tabindex="-1"></a>    df_version_pruned[<span class="st">'creationYear'</span>] <span class="op">=</span> pd.to_datetime(df_version_pruned[<span class="st">'creationDate'</span>], <span class="bu">format</span><span class="op">=</span><span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">"</span>).dt.year</span>
<span id="cb37-113"><a href="#cb37-113" aria-hidden="true" tabindex="-1"></a>    df_version_pruned[<span class="st">'publicationYear'</span>] <span class="op">=</span> pd.to_datetime(df_version_pruned[<span class="st">'publicationDate'</span>], <span class="bu">format</span><span class="op">=</span><span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">"</span>).dt.year</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The following block of code is run regardless of whether you queried the Versions endpoint or not. It standardizes some columns and creates some additional date columns.</p>
<div id="b07f1fab" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>df_native_pruned <span class="op">=</span> df_select_concatenated_exist[[<span class="st">"datasetID"</span>, <span class="st">"totalVersion"</span>, <span class="st">"filename"</span>, <span class="st">"fileID"</span>, <span class="st">"mimeType"</span>, <span class="st">"friendlyType"</span>, <span class="st">"fileSize"</span>, <span class="st">"storageIdentifier"</span>, <span class="st">"creationDate"</span>, <span class="st">"publicationDate"</span>, <span class="st">"institution"</span>, <span class="st">"doi"</span>, <span class="st">"fileSizeBin"</span>, <span class="st">"title"</span>, <span class="st">"dataverse"</span>]]</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>df_native_pruned <span class="op">=</span> df_native_pruned.copy()</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>df_native_pruned[<span class="st">'creationYear'</span>] <span class="op">=</span> pd.to_datetime(df_native_pruned[<span class="st">'creationDate'</span>], <span class="bu">format</span><span class="op">=</span><span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">T%H:%M:%SZ"</span>).dt.year</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>df_native_pruned[<span class="st">'publicationYear'</span>] <span class="op">=</span> pd.to_datetime(df_native_pruned[<span class="st">'publicationDate'</span>], <span class="bu">format</span><span class="op">=</span><span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">"</span>).dt.year</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="conditional-concatenation" class="level3">
<h3 class="anchored" data-anchor-id="conditional-concatenation">Conditional concatenation</h3>
<p>If you ran the Versions endpoint process, you will need to combine that with the first Native API output and de-duplicate. This block of code uses an ‘if-else’ statement to either combine the two dataframes and then de-duplicate them (both file-level and author-level), or it just does the de-duplication process.</p>
<div id="b760328c" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> versionsAPI:</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    df_all_files_concat <span class="op">=</span> pd.concat([df_version_pruned, df_native_pruned], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    df_all_files_concat <span class="op">=</span> df_all_files_concat.rename(columns<span class="op">=</span>{<span class="st">'title'</span>: <span class="st">'datasetTitle'</span>})</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">#deduplicate</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">##create fake versionID for drafts to ensure proper sorting and deduplicating</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    df_all_files_concat[<span class="st">'versionID'</span>] <span class="op">=</span> df_all_files_concat[<span class="st">'versionID'</span>].fillna(<span class="dv">9999999</span>)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    df_all_files_concat <span class="op">=</span> df_all_files_concat.sort_values(by<span class="op">=</span><span class="st">'versionID'</span>)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    df_all_files_concat_deduplicated <span class="op">=</span> df_all_files_concat.drop_duplicates(subset<span class="op">=</span>[<span class="st">'storageIdentifier'</span>], keep<span class="op">=</span><span class="st">'first'</span>)</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    df_all_files_concat_deduplicated <span class="op">=</span> df_all_files_concat_deduplicated.copy()</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    df_all_files_concat_deduplicated[<span class="st">'versionID'</span>] <span class="op">=</span> df_all_files_concat_deduplicated[<span class="st">'versionID'</span>].replace(<span class="dv">9999999</span>, <span class="va">None</span>)</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    df_all_authors_concat <span class="op">=</span> pd.concat([df_author_entries, df_author_entries_versions], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    df_all_authors_concat_deduplicated <span class="op">=</span> df_all_authors_concat.drop_duplicates(subset<span class="op">=</span>[<span class="st">'doi'</span>, <span class="st">'authorName'</span>, <span class="st">'authorAffiliation'</span>, <span class="st">'currentStatus'</span>], keep<span class="op">=</span><span class="st">'first'</span>)</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">#sort on status and then total version, setting 'DRAFT' at bottom to remove this version for published datasets that are in draft state, retain entry of 'PUBLISHED' and then to keep the earliest version</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>    df_native_pruned <span class="op">=</span> df_native_pruned.sort_values(by<span class="op">=</span>[<span class="st">'currentStatus'</span>, <span class="st">'totalVersion'</span>], ascending<span class="op">=</span>[<span class="va">False</span>, <span class="va">True</span>])</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>    df_all_files_concat_deduplicated <span class="op">=</span> df_native_pruned.drop_duplicates(subset<span class="op">=</span>[<span class="st">'storageIdentifier'</span>], keep<span class="op">=</span><span class="st">'first'</span>)</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>    df_all_authors_concat_deduplicated <span class="op">=</span> df_author_entries.drop_duplicates(subset<span class="op">=</span>[<span class="st">'doi'</span>, <span class="st">'authorName'</span>, <span class="st">'authorAffiliation'</span>, <span class="st">'currentStatus'</span>], keep<span class="op">=</span><span class="st">'first'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="metadata-assessment-part-3" class="level3">
<h3 class="anchored" data-anchor-id="metadata-assessment-part-3">Metadata assessment: part 3</h3>
<p>Finally we have reached the part that is probably most interesting to some. A wide range of metadata assessments are made here (regardless of whether you queried the Versions endpoint). This includes:</p>
<ul>
<li>Whether a file includes ‘readme’, ‘codebook’, or ‘dictionary’ (proxy for data dictionary) in the filename</li>
<li>Converting mimeTypes to friendlyFormats; the Dataverse API does have an existing field for this, which is included in the subsetted outputs, but I find that it still needs work to standardize, and I had this giant key-value list anyway from a different script that uses APIs that don’t have friendlyFormat information.</li>
<li>Whether a file is a software format (e.g., Python, R, C++)</li>
<li>Whether a file is a compressed archive (e.g., .zip, .gzip, .tar)</li>
<li>Whether a file is a Microsoft Office format</li>
</ul>
<div id="acc0410d" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">#metadata assessment</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co">##readme presence</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>df_all_files_concat_deduplicated.loc[:,<span class="st">'isREADME'</span>] <span class="op">=</span> df_all_files_concat_deduplicated[<span class="st">'filename'</span>].<span class="bu">str</span>.contains(<span class="st">'readme'</span>, case<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>df_all_files_concat_deduplicated.loc[:,<span class="st">'isCodebook'</span>] <span class="op">=</span> df_all_files_concat_deduplicated[<span class="st">'filename'</span>].<span class="bu">str</span>.contains(<span class="st">'codebook'</span>, case<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>df_all_files_concat_deduplicated.loc[:,<span class="st">'isDataDict'</span>] <span class="op">=</span> df_all_files_concat_deduplicated[<span class="st">'filename'</span>].<span class="bu">str</span>.contains(<span class="st">'dictionary'</span>, case<span class="op">=</span><span class="va">False</span>) <span class="co">#need to check sensitivity</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co">##create separate friendlyFormat column</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>formatMap <span class="op">=</span> config[<span class="st">'FORMAT_MAP'</span>]</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>df_all_files_concat_deduplicated.loc[:,<span class="st">'friendlyFormat_manual'</span>] <span class="op">=</span> df_all_files_concat_deduplicated[<span class="st">'mimeType'</span>].<span class="bu">apply</span>(</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: formatMap.get(x.strip(), x.strip()) <span class="cf">if</span> <span class="bu">isinstance</span>(x, <span class="bu">str</span>) <span class="kw">and</span> x <span class="op">!=</span> <span class="st">"no match found"</span> <span class="cf">else</span> <span class="st">"no files"</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="co">##file formats</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>softwareFormats <span class="op">=</span> <span class="bu">set</span>(config[<span class="st">'SOFTWARE_FORMATS'</span>].keys())</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>compressedFormats <span class="op">=</span> <span class="bu">set</span>(config[<span class="st">'COMPRESSED_FORMATS'</span>].keys())</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>microsoftFormats <span class="op">=</span> <span class="bu">set</span>(config[<span class="st">'MICROSOFT_FORMATS'</span>].keys())</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Assume softwareFormats is a set of friendly software format names</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>df_all_files_concat_deduplicated.loc[:,<span class="st">'isSoftware'</span>] <span class="op">=</span> df_all_files_concat_deduplicated[<span class="st">'mimeType'</span>].<span class="bu">apply</span>(</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: <span class="bu">any</span>(part.strip() <span class="kw">in</span> softwareFormats <span class="cf">for</span> part <span class="kw">in</span> x.split(<span class="st">';'</span>)) <span class="cf">if</span> <span class="bu">isinstance</span>(x, <span class="bu">str</span>) <span class="cf">else</span> <span class="va">False</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>df_all_files_concat_deduplicated.loc[:,<span class="st">'isCompressed'</span>] <span class="op">=</span> df_all_files_concat_deduplicated[<span class="st">'mimeType'</span>].<span class="bu">apply</span>(</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: <span class="bu">any</span>(part.strip() <span class="kw">in</span> compressedFormats <span class="cf">for</span> part <span class="kw">in</span> x.split(<span class="st">';'</span>)) <span class="cf">if</span> <span class="bu">isinstance</span>(x, <span class="bu">str</span>) <span class="cf">else</span> <span class="va">False</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>df_all_files_concat_deduplicated.loc[:,<span class="st">'isMSOffice'</span>] <span class="op">=</span> df_all_files_concat_deduplicated[<span class="st">'mimeType'</span>].<span class="bu">apply</span>(</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: <span class="bu">any</span>(part.strip() <span class="kw">in</span> microsoftFormats <span class="cf">for</span> part <span class="kw">in</span> x.split(<span class="st">';'</span>)) <span class="cf">if</span> <span class="bu">isinstance</span>(x, <span class="bu">str</span>) <span class="cf">else</span> <span class="va">False</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>df_all_files_concat_deduplicated.to_csv(<span class="ss">f"outputs/</span><span class="sc">{</span>todayDate<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>institutionFilename<span class="sc">}</span><span class="ss">_all-files-deduplicated.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now you might want to combine all of the files for a given dataset into a single entry; this would be important for things like analyzing total deposit size (inclusive of all versions) or otherwise doing some of the metadata assessments at the dataset level. The following code block does that. It first defines the column(s) to be mathematically added together (only one in this case); all others will be combined into a semi-colon-delimited string. There is also some metadata editing to clean up entries (e.g., when a recombined dataset record contains ‘False; True’ for a Boolean variable, this is converted to ‘TRUE’). For variables where some values could be duplicated (e.g., 100 text files, only a set [unique values] is returned)</p>
<div id="91ea9745" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>sum_columns <span class="op">=</span> [<span class="st">'fileSize'</span>]</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> agg_func(column_name):</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> column_name <span class="kw">in</span> sum_columns:</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'sum'</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">lambda</span> x: <span class="bu">sorted</span>(<span class="bu">set</span>(<span class="bu">map</span>(<span class="bu">str</span>, x)))</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>agg_funcs <span class="op">=</span> {col: agg_func(col)<span class="cf">for</span> col <span class="kw">in</span> df_all_files_concat_deduplicated.columns <span class="cf">if</span> col <span class="op">!=</span> <span class="st">'datasetID'</span>}</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>df_tdr_all_files_combined <span class="op">=</span> df_all_files_concat_deduplicated.groupby(<span class="st">'datasetID'</span>).agg(agg_funcs).reset_index()</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all list-type columns to comma-separated strings</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> df_tdr_all_files_combined.columns:</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> df_tdr_all_files_combined[col].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="bu">isinstance</span>(x, <span class="bu">list</span>)).<span class="bu">any</span>():</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>        df_tdr_all_files_combined[col] <span class="op">=</span> df_tdr_all_files_combined[col].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="st">'; '</span>.join(<span class="bu">map</span>(<span class="bu">str</span>, x)))</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>tdr_all_datasets_deduplicated <span class="op">=</span> df_tdr_all_files_combined.drop_duplicates(subset<span class="op">=</span><span class="st">'datasetID'</span>, keep<span class="op">=</span><span class="st">'first'</span>)</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>tdr_all_datasets_deduplicated_pruned <span class="op">=</span> tdr_all_datasets_deduplicated[[<span class="st">"datasetID"</span>, <span class="st">"versionID"</span>, <span class="st">"totalVersion"</span>, <span class="st">"mimeType"</span>, <span class="st">"friendlyType"</span>, <span class="st">"fileSize"</span>, <span class="st">"creationDate"</span>, <span class="st">"publicationDate"</span>, <span class="st">"institution"</span>, <span class="st">"doi"</span>, <span class="st">"datasetTitle"</span>, <span class="st">"dataverse"</span>, <span class="st">"creationYear"</span>, <span class="st">"publicationYear"</span>, <span class="st">"isREADME"</span>, <span class="st">"isCodebook"</span>, <span class="st">"isDataDict"</span>, <span class="st">"friendlyFormat_manual"</span>, <span class="st">"isSoftware"</span>, <span class="st">"isCompressed"</span>, <span class="st">"isMSOffice"</span>]]</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a><span class="co">#handles entries where aggregation returned a mixed 'False;True' value</span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normalize_boolean_column(col):</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> col.<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="va">True</span> <span class="cf">if</span> <span class="bu">isinstance</span>(x, <span class="bu">str</span>) <span class="kw">and</span> <span class="st">'true'</span> <span class="kw">in</span> x.lower() <span class="cf">else</span> <span class="va">False</span>)</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>bool_columns <span class="op">=</span> [<span class="st">"isREADME"</span>, <span class="st">"isCodebook"</span>, <span class="st">"isDataDict"</span>, <span class="st">"isSoftware"</span>, <span class="st">"isCompressed"</span>, <span class="st">"isMSOffice"</span>]</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>tdr_all_datasets_deduplicated_pruned <span class="op">=</span> tdr_all_datasets_deduplicated_pruned.copy()</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> bool_columns:</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>    tdr_all_datasets_deduplicated_pruned[col] <span class="op">=</span> normalize_boolean_column(tdr_all_datasets_deduplicated_pruned[col])</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>tdr_all_datasets_deduplicated_pruned <span class="op">=</span> tdr_all_datasets_deduplicated_pruned.rename(columns<span class="op">=</span>{<span class="st">'isREADME'</span>: <span class="st">'containsREADME'</span>, <span class="st">'isCodebook'</span>: <span class="st">'containsCodebook'</span>, <span class="st">'isDataDict'</span>: <span class="st">'containsDataDict'</span>, <span class="st">'isSoftware'</span>: <span class="st">'containsSoftware'</span>, <span class="st">'isCompressed'</span>: <span class="st">'containsCompressed'</span>, <span class="st">'isMSOffice'</span>: <span class="st">'containsMSOffice'</span>, <span class="st">'fileSize'</span>: <span class="st">'datasetSize'</span>})</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a><span class="co">#returns only the highest value for the version number</span></span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_max_version(val):</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(val, <span class="bu">str</span>):</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>            versions <span class="op">=</span> [<span class="bu">float</span>(v.strip()) <span class="cf">for</span> v <span class="kw">in</span> val.split(<span class="st">';'</span>)]</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">max</span>(versions)</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">ValueError</span>:</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> val  <span class="co"># In case of unexpected format</span></span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> val</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>tdr_all_datasets_deduplicated_pruned[<span class="st">'totalVersion'</span>] <span class="op">=</span> tdr_all_datasets_deduplicated_pruned[<span class="st">'totalVersion'</span>].<span class="bu">apply</span>(extract_max_version)</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a><span class="co">#binning datasets by size</span></span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>tdr_all_datasets_deduplicated_pruned <span class="op">=</span> assign_size_bins(tdr_all_datasets_deduplicated_pruned, column<span class="op">=</span><span class="st">'datasetSize'</span>, new_column<span class="op">=</span><span class="st">'datasetSizeBin'</span>)</span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a>tdr_all_datasets_deduplicated_pruned.to_csv(<span class="ss">f"outputs/</span><span class="sc">{</span>todayDate<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>institutionFilename<span class="sc">}</span><span class="ss">_all-datasets-combined.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="metadata-summary" class="level3">
<h3 class="anchored" data-anchor-id="metadata-summary">Metadata summary</h3>
<p>The script also returns two summary files that are likely to be of interest. The first summary is the amount of storage created by calendar year. If these numbers are discordant with previous estimates, there is a very good chance that this is because older versions are not being accounted for (either that files have been replaced or that files existed in the system well before their latest publication). For instance, if you’re not paying attention, a versioned dataset most recently published in 2023 but that had a 10 GB file published in 2021, could be mistakenly counted for 2023. The second summary is the number of unique instances of file formats. The way that this calculation is done, it counts each file type once per dataset, so a dataset with 2,000 CSV files and a dataset with 1 CSV file are each counted as ‘1’ for the total number of datasets with CSV files; this is done to eliminate the discipline-specific variability in repetitive file formats (e.g., simulation datasets with millions of text files).</p>
<div id="02470dbb" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">#size summary</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>size_by_year <span class="op">=</span> df_all_files_concat_deduplicated.groupby(<span class="st">'creationYear'</span>)[<span class="st">'fileSize'</span>].<span class="bu">sum</span>().reset_index()</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>size_by_year[<span class="st">'fileGB'</span>] <span class="op">=</span> size_by_year[<span class="st">'fileSize'</span>] <span class="op">/</span> <span class="dv">1000000000</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Annual size summary'</span>)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(size_by_year)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>size_by_year.to_csv(<span class="ss">f"outputs/</span><span class="sc">{</span>todayDate<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>institutionFilename<span class="sc">}</span><span class="ss">_annual-size-summary.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Annual size summary
   creationYear      fileSize     fileGB
0          2017  1.838593e+09   1.838593
1          2018  1.349090e+09   1.349090
2          2019  2.931868e+08   0.293187
3          2020  7.414284e+08   0.741428
4          2021  1.230189e+10  12.301894
5          2022  3.301655e+08   0.330166
6          2023  1.336943e+10  13.369429
7          2024  2.388476e+10  23.884762
8          2025  6.993964e+09   6.993964</code></pre>
</div>
</div>
<div id="466ef14d" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">#file format summary</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="co">##can substitute 'friendlyType' for 'mimeType' but will get some aggregating into 'unknown'</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>unique_datasets_per_format <span class="op">=</span> df_all_files_concat_deduplicated.groupby(<span class="st">'friendlyFormat_manual'</span>)[<span class="st">'datasetID'</span>].nunique()</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Total file format summary'</span>)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(unique_datasets_per_format)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>unique_datasets_per_format.to_csv(<span class="ss">f"outputs/</span><span class="sc">{</span>todayDate<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>institutionFilename<span class="sc">}</span><span class="ss">_unique-format-summary.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Total file format summary
friendlyFormat_manual
AVI                           1
Binary                       10
C Source                      1
CSV                          13
DVB Subtitle                  1
Fixed Field                   2
GIF                           1
GZIP (compressed archive)     1
HDF5                          3
JPEG                          4
JSON                          1
Jupyter Notebook              1
KMZ                           1
MATLAB                        1
MP4                           2
MS Excel                      1
MS PowerPoint                 1
MS Shortcut                   1
MS Word                       7
Makefile                      1
Markdown                      3
MiniSEED                      1
NetCDF                        4
PDF                          15
PNG                           6
Pascal                        1
Plain text                   13
PostScript                    1
Python                        3
R Notebook                    3
R Syntax                      4
SVG                           1
TAR (compressed archive)      1
TIFF                          9
TSV                          18
XFig                          1
ZIP (compressed archive)      4
Zipped Shapefile              2
Name: datasetID, dtype: int64</code></pre>
</div>
</div>
</section>
<section id="metadata-assessment-part-4" class="level3">
<h3 class="anchored" data-anchor-id="metadata-assessment-part-4">Metadata assessment: part 4</h3>
<p>The last metadata assessment is for the author-level data. The script assesses the following:</p>
<ul>
<li>Whether an author has a ROR-linked affiliation</li>
<li>Whether an author has a properly formatted ORCID (in Dataverse, this means that the ORCID is hyperlinked and that it appears in two fields)</li>
<li>Whether an author has an ORCID, but it is not properly formatted because it lacks hyphens</li>
<li>Whether an author has an ORCID, but it is not properly formatted because it is not in URL form</li>
<li>Whether an author has an ORCID, but it is not properly formatted because it appears in only one of the two fields</li>
<li>Whether an author has an ORCID, but it is malformed in some fashion (if any of the previous three are TRUE)</li>
<li>Whether an author’s name appears malformed (First Last rather than Last, First); this is based on whether there is a space in the name value but no comma</li>
<li>Whether an author’s initial appears malformed (probably middle, but could be first); this is based on whether there is a standalone letter with no period after it</li>
</ul>
<div id="8a0cc96b" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co">#author assessment</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="co">##is ROR present</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>df_all_authors_concat_deduplicated <span class="op">=</span> df_all_authors_concat_deduplicated.copy()</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>df_all_authors_concat_deduplicated.loc[:, <span class="st">'missingROR'</span>] <span class="op">=</span> (df_all_authors_concat_deduplicated[<span class="st">'rorID'</span>].isna() <span class="op">|</span> (df_all_authors_concat_deduplicated[<span class="st">'rorID'</span>] <span class="op">==</span> <span class="st">''</span>))</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co">##is any author ID system present</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>df_all_authors_concat_deduplicated.loc[:, <span class="st">'missingAuthorScheme'</span>] <span class="op">=</span> (df_all_authors_concat_deduplicated[<span class="st">'authorIdentifierScheme'</span>].isna() <span class="op">|</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    (df_all_authors_concat_deduplicated[<span class="st">'authorIdentifierScheme'</span>] <span class="op">==</span> <span class="st">''</span>))</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="co">##ORCID present and appropriately formatted</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>df_all_authors_concat_deduplicated.loc[:, <span class="st">'properORCID'</span>] <span class="op">=</span> (</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    df_all_authors_concat_deduplicated[<span class="st">'authorIdentifierScheme'</span>].<span class="bu">str</span>.upper() <span class="op">==</span> <span class="st">'ORCID'</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>) <span class="op">&amp;</span> df_all_authors_concat_deduplicated[<span class="st">'authorIdentifier'</span>].<span class="bu">str</span>.contains(<span class="st">'https://orcid.org/'</span>, na<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="co">##is ORCID present but malformatted (not hyperlinked)</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>df_all_authors_concat_deduplicated.loc[:,<span class="st">'malformedORCID_noHyphens'</span>] <span class="op">=</span> (</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>    df_all_authors_concat_deduplicated[<span class="st">'authorIdentifierScheme'</span>].<span class="bu">str</span>.upper() <span class="op">==</span> <span class="st">'ORCID'</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>) <span class="op">&amp;</span> <span class="op">~</span>df_all_authors_concat_deduplicated[<span class="st">'authorIdentifier'</span>].<span class="bu">str</span>.contains(<span class="st">'-'</span>, na<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a><span class="co">##is ORCID present but malformatted (no dashes)</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>df_all_authors_concat_deduplicated.loc[:,<span class="st">'malformedORCID_noURL'</span>] <span class="op">=</span> (</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>    df_all_authors_concat_deduplicated[<span class="st">'authorIdentifierScheme'</span>].<span class="bu">str</span>.upper() <span class="op">==</span> <span class="st">'ORCID'</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>) <span class="op">&amp;</span> <span class="op">~</span>df_all_authors_concat_deduplicated[<span class="st">'authorIdentifier'</span>].<span class="bu">str</span>.contains(<span class="st">'https://orcid.org/'</span>, na<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a><span class="co">##is ORCID present but malformatted (single field)</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>df_all_authors_concat_deduplicated.loc[:,<span class="st">'malformedORCID_singleField'</span>] <span class="op">=</span> (</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>    df_all_authors_concat_deduplicated[<span class="st">'authorIdentifierScheme'</span>].<span class="bu">str</span>.upper() <span class="op">==</span> <span class="st">'ORCID'</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>) <span class="op">&amp;</span> df_all_authors_concat_deduplicated[<span class="st">'authorIdentifierExpanded'</span>].isna()</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>df_all_authors_concat_deduplicated.loc[:, <span class="st">'malformedORCID_any'</span>] <span class="op">=</span> (</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>    df_all_authors_concat_deduplicated[<span class="st">'malformedORCID_noHyphens'</span>] <span class="op">|</span></span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>    df_all_authors_concat_deduplicated[<span class="st">'malformedORCID_noURL'</span>] <span class="op">|</span></span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>    df_all_authors_concat_deduplicated[<span class="st">'malformedORCID_singleField'</span>]</span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a><span class="co">##malformed author name (order)</span></span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>df_all_authors_concat_deduplicated.loc[:, <span class="st">'malformedOrder'</span>] <span class="op">=</span> (</span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a>    df_all_authors_concat_deduplicated[<span class="st">'authorName'</span>].<span class="bu">str</span>.contains(<span class="st">' '</span>, na<span class="op">=</span><span class="va">False</span>) <span class="op">&amp;</span> </span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">~</span>df_all_authors_concat_deduplicated[<span class="st">'authorName'</span>].<span class="bu">str</span>.contains(<span class="st">','</span>, na<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a><span class="co">##malformed initial (standalone initial without period)</span></span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a>df_all_authors_concat_deduplicated.loc[:, <span class="st">'malformedInitial'</span>] <span class="op">=</span> df_all_authors_concat_deduplicated[<span class="st">'authorName'</span>].<span class="bu">str</span>.contains(<span class="vs">r'\b[A-Z]\b(?!\.)'</span>, regex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a>df_all_authors_concat_deduplicated.loc[:, <span class="st">'malformedName'</span>] <span class="op">=</span> (</span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>    df_all_authors_concat_deduplicated[<span class="st">'malformedOrder'</span>] <span class="op">|</span></span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a>    df_all_authors_concat_deduplicated[<span class="st">'malformedInitial'</span>] </span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a>df_all_authors_concat_deduplicated <span class="op">=</span> df_all_authors_concat_deduplicated.sort_values(by<span class="op">=</span><span class="st">'authorName'</span>)</span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a>df_all_authors_concat_deduplicated.to_csv(<span class="ss">f'outputs/</span><span class="sc">{</span>todayDate<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>institutionFilename<span class="sc">}</span><span class="ss">_all-authors.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you aren’t a superuser, running this script across some/all TDR institutions will overweight the results in favour of your home institution because you won’t pick up unpublished datasets for other institutions. The following code block uses the <em>excludeDrafts</em> toggle to determine whether to export versions of the final output files with unpublished datasets/files removed.</p>
<div id="d2b5761b" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> excludeDrafts:</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#authors</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    df_all_authors_concat_deduplicated_published <span class="op">=</span> df_all_authors_concat_deduplicated[df_all_authors_concat_deduplicated[<span class="st">'currentStatus'</span>] <span class="op">!=</span> <span class="st">'DRAFT'</span>]</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    df_all_authors_concat_deduplicated_published.to_csv(<span class="ss">f'outputs/</span><span class="sc">{</span>todayDate<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>institutionFilename<span class="sc">}</span><span class="ss">_all-authors-PUBLISHED.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">#datasets</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    tdr_all_datasets_deduplicated_pruned_published <span class="op">=</span> tdr_all_datasets_deduplicated_pruned[tdr_all_datasets_deduplicated_pruned[<span class="st">'publicationDate'</span>].notna() <span class="op">&amp;</span> (tdr_all_datasets_deduplicated_pruned[<span class="st">'publicationDate'</span>] <span class="op">!=</span> <span class="st">''</span>)]</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    tdr_all_datasets_deduplicated_pruned_published.to_csv(<span class="ss">f"outputs/</span><span class="sc">{</span>todayDate<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>institutionFilename<span class="sc">}</span><span class="ss">_all-datasets-combined-PUBLISHED.csv"</span>)</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#files</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    df_all_files_concat_deduplicated_published <span class="op">=</span> df_all_files_concat_deduplicated[df_all_files_concat_deduplicated[<span class="st">'publicationDate'</span>].notna() <span class="op">&amp;</span> (df_all_files_concat_deduplicated[<span class="st">'publicationDate'</span>] <span class="op">!=</span> <span class="st">''</span>)]</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>    df_all_files_concat_deduplicated_published.to_csv(<span class="ss">f"outputs/</span><span class="sc">{</span>todayDate<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>institutionFilename<span class="sc">}</span><span class="ss">_all-files-deduplicated-PUBLISHED.csv"</span>)</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">#size summary</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    size_by_year_published <span class="op">=</span> df_all_files_concat_deduplicated_published.groupby(<span class="st">'creationYear'</span>)[<span class="st">'fileSize'</span>].<span class="bu">sum</span>().reset_index()</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>    size_by_year_published[<span class="st">'fileGB'</span>] <span class="op">=</span> size_by_year_published[<span class="st">'fileSize'</span>] <span class="op">/</span> <span class="dv">1000000000</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    size_by_year_published.to_csv(<span class="ss">f"outputs/</span><span class="sc">{</span>todayDate<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>institutionFilename<span class="sc">}</span><span class="ss">_annual-size-summary-PUBLISHED.csv"</span>)</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">#file format summary</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">##can substitute 'friendlyType' for 'mimeType' but will get some aggregating into 'unknown'</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>    unique_datasets_per_format_PUBLISHED <span class="op">=</span> df_all_files_concat_deduplicated_published.groupby(<span class="st">'friendlyFormat_manual'</span>)[<span class="st">'datasetID'</span>].nunique()</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>    unique_datasets_per_format_PUBLISHED.to_csv(<span class="ss">f"outputs/</span><span class="sc">{</span>todayDate<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>institutionFilename<span class="sc">}</span><span class="ss">_unique-format-summary-PUBLISHED.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="c5f0ac12" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Done.</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Time to run: </span><span class="sc">{</span>datetime<span class="sc">.</span>now() <span class="op">-</span> startTime<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> test:</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"**REMINDER: THIS IS A TEST RUN, AND ANY RESULTS ARE NOT COMPLETE!**"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Done.

Time to run: 0:01:04.276373

**REMINDER: THIS IS A TEST RUN, AND ANY RESULTS ARE NOT COMPLETE!**</code></pre>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>